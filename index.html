<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel Formula Coach — Tutorial • Quiz • Practice • Datasets</title>
  <meta name="description" content="เรียนรู้สูตร Excel แบบโค้ชส่วนตัว: ค้นหา อธิบาย ฝึกทำควิซ พร้อมชุดข้อมูลตัวอย่าง และบันทึกความคืบหน้าอัตโนมัติในเบราว์เซอร์ของคุณ" />
  <meta name="color-scheme" content="light dark" />
  <style>
    /* -----------------------------
       Design Tokens
    ------------------------------*/
    :root {
      --bg: #0b0e14;
      --ui: #121826;
      --card: #0f1525;
      --text: #e5ecff;
      --muted: #9fb0d3;
      --accent: #58c4ff;
      --accent-2: #8aeb8a;
      --danger: #ff6b6b;
      --ok: #23d18b;
      --warn: #ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --radius: 14px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --container: 1180px;
    }
    :root.light {
      --bg: #f6f8fc;
      --ui: #ffffff;
      --card: #ffffff;
      --text: #0b0e14;
      --muted: #52607a;
      --accent: #0066ff;
      --accent-2: #0bb36e;
      --shadow: 0 12px 28px rgba(10, 14, 25, .08);
    }

    /* -----------------------------
       Base
    ------------------------------*/
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font: 16px/1.6 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial, "Helvetica Neue", Helvetica, sans-serif;
      background: radial-gradient(1200px 600px at 70% -20%, rgba(88,196,255,.2), transparent 60%),
                  radial-gradient(800px 500px at -10% 10%, rgba(138,235,138,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      letter-spacing: .2px;
    }
    a { color: var(--accent); text-decoration: none }
    a:hover { text-decoration: underline }
    button, input, select, textarea { font: inherit }

    .container { width: 100%; max-width: var(--container); margin: 0 auto; padding: 24px }

    /* -----------------------------
       Header / Topbar
    ------------------------------*/
    header {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(120%) blur(10px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }
    .topbar {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px; align-items: center;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .3px }
    .fx {
      width: 34px; height: 34px; display: grid; place-items: center;
      border-radius: 10px; background: linear-gradient(140deg, var(--accent), var(--accent-2));
      color: #001018; box-shadow: var(--shadow); font-weight: 900;
    }

    .searchbar { display: grid; grid-template-columns: 1fr auto; gap: 10px }
    .searchbar input[type="search"]{
      width: 100%; border: 1px solid color-mix(in oklab, var(--muted) 30%, transparent);
      background: var(--card); color: var(--text); padding: 12px 14px; border-radius: var(--radius); outline: none;
    }
    .searchbar input[type="search"]::placeholder { color: color-mix(in oklab, var(--muted) 65%, transparent) }
    .kbd { margin-left: 10px; border: 1px solid color-mix(in oklab, var(--muted) 40%, transparent); padding: 2px 8px; border-radius: 8px; font-size: .85rem; color: var(--muted) }

    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 14px; border-radius: 10px; border: 1px solid transparent;
      background: color-mix(in oklab, var(--card) 85%, #0000);
      color: var(--text); cursor: pointer;
      transition: .2s ease transform, .2s ease box-shadow, .2s ease background;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow) }
    .btn.ghost { background: transparent; border-color: color-mix(in oklab, var(--muted) 30%, transparent) }
    .btn.accent { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #001018; font-weight: 700 }
    .btn.danger { background: linear-gradient(135deg, #ff8a8a, #ff6b6b); color: #190000; }
    .btn.small { padding: 8px 12px; border-radius: 8px; }

    .badge { font-size: .85rem; color: var(--muted); display: inline-flex; align-items: center; gap: 8px }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok) }

    /* -----------------------------
       Chips / Tabs
    ------------------------------*/
    .chips { display: flex; gap: 10px; overflow:auto; padding: 8px 0 2px 0; scrollbar-width: thin }
    .chip {
      flex: 0 0 auto; padding: 8px 12px; border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--muted) 35%, transparent);
      background: color-mix(in oklab, var(--card) 80%, #0000); color: var(--text);
      cursor: pointer; font-weight: 600; font-size: .92rem;
    }
    .chip.active { border-color: transparent; background: color-mix(in oklab, var(--accent) 25%, #0000) }

    .tabs { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap }
    .tab {
      padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 700;
      border: 1px solid color-mix(in oklab, var(--muted) 35%, transparent);
      background: color-mix(in oklab, var(--ui) 85%, transparent);
    }
    /* ทำให้ปุ่มปกติสว่างขึ้น */
.tab {
  color: var(--text);
  background: color-mix(in oklab, var(--card) 95%, var(--accent) 5%);
  font-weight: 600;
}

/* เพิ่ม hover ให้ดูเด่นขึ้น */
.tab:hover {
  background: color-mix(in oklab, var(--accent) 20%, var(--card) 80%);
  color: #fff; /* ขาวชัดเจน */
}
    .tab.active {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: #001018; /* ทำให้ตัวอักษรเข้มขึ้น */
  font-weight: 700;
  box-shadow: 0 0 10px var(--accent); /* เพิ่มเงาสว่าง */
}

    /* -----------------------------
       Cards / Panels / Grid
    ------------------------------*/
    .grid { margin-top: 18px; display: grid; gap: 16px; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ) }
    .card { background: var(--card); border: 1px solid color-mix(in oklab, var(--muted) 22%, transparent); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow) }
    .card h3 { margin: 4px 0 10px 0 }
    .card .meta { font-size: .9rem; color: var(--muted) }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 99px; font-size: .8rem; border:1px solid color-mix(in oklab, var(--muted) 35%, transparent); color: var(--muted) }

    .panel { margin-top: 16px; background: var(--card); border:1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow) }
    .panel h4, .panel h3 { margin: 6px 0 12px 0 }

    /* -----------------------------
       Forms (Responsive Grid)
    ------------------------------*/
    .form-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .fg-12 { grid-column: span 12 }
    .fg-6  { grid-column: span 6 }
    .fg-4  { grid-column: span 4 }
    .fg-3  { grid-column: span 3 }
    .fg-2  { grid-column: span 2 }

    .field { display:flex; flex-direction: column; gap:6px }
    .field input[type="text"],
    .field input[type="number"],
    .field input[type="search"],
    .field select,
    .field textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid color-mix(in oklab, var(--muted) 30%, transparent);
      background: var(--card); color: var(--text);
    }

    /* -----------------------------
       Table (Datasets)
    ------------------------------*/
    table { width: 100%; border-collapse: collapse; font-variant-numeric: tabular-nums }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px dashed color-mix(in oklab, var(--muted) 30%, transparent) }
    th { position: sticky; top: 0; background: color-mix(in oklab, var(--ui) 90%, transparent); z-index: 1 }

    /* -----------------------------
       Dialog / Modal
    ------------------------------*/
    dialog { border: none; padding: 0; border-radius: 16px; width: min(880px, 92vw); background: var(--card); color: var(--text); box-shadow: var(--shadow) }
    dialog::backdrop { background: rgba(0,0,0,.35) }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid color-mix(in oklab, var(--muted) 25%, transparent) }
    .modal-body { padding: 16px 18px 20px 18px; max-height: 70vh; overflow: auto }
    .close { border:none; background:transparent; color: var(--muted); cursor:pointer; font-size: 22px }

    /* -----------------------------
       Footer / Utils
    ------------------------------*/
    footer { text-align: center; color: var(--muted); padding: 30px 0 50px }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center }
    .right { margin-left: auto }
    .muted { color: var(--muted) }
    .sr-only { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background: color-mix(in oklab, var(--muted) 10%, transparent); padding: 2px 6px; border-radius: 8px }

    /* Explain styles */
    .ex { display: grid; gap: 10px }
    .ex .head { display:flex; gap:10px; align-items:center; flex-wrap: wrap }
    .ex .chip { padding: 3px 8px; border-radius: 999px; border:1px solid color-mix(in oklab, var(--muted) 35%, transparent); color: var(--muted); font-size: .8rem }
    .ex .ok { color: var(--ok) }
    .ex .warn { color: var(--warn) }
    .ex .danger { color: var(--danger) }
    .ex .arglist { margin: 6px 0 0 0; padding-left: 18px }
    .ex .arglist li { margin: 4px 0 }
    .ex details { background: color-mix(in oklab, var(--muted) 10%, transparent); padding: 8px 10px; border-radius: 10px; border:1px dashed color-mix(in oklab, var(--muted) 25%, transparent) }
    .ex .kv { display:flex; gap:6px; align-items:center; flex-wrap: wrap }
    .ex .kv b { min-width: 180px }
    .ex .box { background: color-mix(in oklab, var(--muted) 10%, transparent); border:1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: 10px; padding: 10px }

    /* -----------------------------
       Confetti
    ------------------------------*/
    canvas#confetti { position: fixed; inset: 0; pointer-events: none; z-index: 60 }

    /* -----------------------------
       Responsive
    ------------------------------*/
    @media (max-width: 980px){
      .topbar { grid-template-columns: 1fr; gap: 10px }
      .toolbar { justify-content: flex-start }
    }
    @media (max-width: 720px){
      .searchbar { grid-template-columns: 1fr }
      .kbd { display:none }
      .fg-6 { grid-column: span 12 }
      .fg-4 { grid-column: span 12 }
      .fg-3 { grid-column: span 12 }
      .fg-2 { grid-column: span 12 }
      .container { padding: 18px }
      .tab { flex: 1 1 auto; text-align: center }
      .ex .kv b { min-width: 120px }
    }
  </style>
</head>
<body>
  <canvas id="confetti" aria-hidden="true"></canvas>

  <!-- Header -->
  <header>
    <div class="container topbar" role="navigation" aria-label="แถบเครื่องมือ">
      <div class="brand" aria-label="โลโก้และชื่อเว็บไซต์">
        <div class="fx" aria-hidden="true">fx</div>
        <div>
          <div style="font-size:1.05rem; opacity:.85">Excel Formula Coach</div>
          <div class="badge"><span class="dot"></span> ทำงานออฟไลน์ • เก็บสถานะในเบราว์เซอร์คุณ</div>
        </div>
      </div>

      <div class="searchbar">
        <label class="sr-only" for="q">ค้นหาสูตร</label>
        <input id="q" type="search" placeholder="ค้นหา… เช่น XLOOKUP, SUMIFS, TEXTJOIN หรือพิมพ์ / เพื่อโฟกัส" autocomplete="off" />
        <div class="kbd">Ctrl + K</div>
      </div>

      <div class="toolbar" role="group" aria-label="การตั้งค่าและข้อมูล">
        <button class="btn ghost" id="themeBtn" title="สลับโหมดแสง/มืด" aria-label="Theme">🌓</button>
        <button class="btn" id="exportBtn" title="ส่งออกข้อมูล" aria-label="Export">⬇️ ส่งออก</button>
        <label class="btn" title="นำเข้าข้อมูล" aria-label="Import">
          ⬆️ นำเข้า
          <input id="importFile" type="file" accept="application/json" hidden />
        </label>
        <button class="btn danger" id="resetBtn" title="รีเซ็ตข้อมูลทั้งหมด" aria-label="Reset">🗑️ รีเซ็ต</button>
      </div>
    </div>

    <div class="container">
      <div class="chips" id="catChips" aria-label="ตัวกรองหมวดหมู่"></div>
      <div class="tabs" role="tablist" aria-label="โหมดการเรียนรู้">
        <button class="tab" data-tab="tutorial" role="tab">Tutorial</button>
        <button class="tab" data-tab="quiz" role="tab">Quiz</button>
        <button class="tab" data-tab="practice" role="tab">Practice</button>
        <button class="tab" data-tab="playground" role="tab">Playground</button>
        <button class="tab" data-tab="datasets" role="tab">Datasets</button>
        <button class="tab" data-tab="explain" role="tab">Explain</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <!-- Tutorial -->
    <section id="tutorial">
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">บทเรียนสูตรยอดนิยม</h2>
          <span class="muted">เริ่มจากพื้นฐาน → สู่ระดับโปร</span>
          <span class="right pill" id="resultCount">0 สูตร</span>
        </div>
        <div class="grid" id="formulaGrid" aria-live="polite"></div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" hidden>
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">ควิซ 10 ข้อ</h2>
          <span class="muted">สุ่มใหม่ทุกครั้ง • ทำให้ได้ &ge; 80% เพื่อปลดล็อกเหรียญ</span>
          <div class="right row">
            <label>ระดับ:
              <select id="quizLevel">
                <option>ทุกระดับ</option>
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Advanced</option>
              </select>
            </label>
            <button class="btn accent" id="startQuiz">เริ่มควิซ</button>
          </div>
        </div>
        <div id="quizArea" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Practice -->
    <section id="practice" hidden>
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">Daily Drills</h2>
          <span class="muted">ฝึกแบบ Spaced Repetition • ระบบจำว่าคุณพลาดตรงไหน</span>
          <button class="btn right" id="practiceRefill">สุ่มโจทย์</button>
        </div>
        <div id="practiceArea" class="grid"></div>
      </div>
    </section>

    <!-- Playground -->
    <section id="playground" hidden>
      <!-- Evaluator -->
      <div class="panel">
        <h2 style="margin-top:0">Formula Playground (Mini Evaluator)</h2>
        <p class="muted">ทดลองฟังก์ชันพื้นฐาน (TEXT/MATH) แบบรวดเร็ว: <span class="code">SUM</span>, <span class="code">AVERAGE</span>, <span class="code">MIN</span>, <span class="code">MAX</span>, <span class="code">LEN</span>, <span class="code">LEFT</span>, <span class="code">RIGHT</span>, <span class="code">UPPER</span>, <span class="code">LOWER</span>, <span class="code">CONCAT</span></p>
        <div class="row">
          <input id="playInput" type="text" placeholder='พิมพ์สูตร เช่น =TEXTJOIN("-",, "A","B","C") หรือ =SUM(10,20,30)' style="flex:1; padding:12px 14px; border-radius:12px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)">
          <button id="runPlay" class="btn accent">Run ▶</button>
        </div>
        <div id="playResult" style="margin-top:12px; font-family: ui-monospace, monospace"></div>
      </div>

      <!-- INDEX Builder (Simplified & Responsive) -->
      <div class="panel" id="indexBuilderPanel">
        <h3 style="margin:0">INDEX Builder — สร้างสูตรอัตโนมัติ</h3>
        <p class="muted" style="margin:.2rem 0 1rem 0">กรอกช่วงข้อมูล แล้วเลือกโหมด <b>พื้นฐาน</b> หรือ <b>ไดนามิก (MATCH)</b> ระบบจะแสดงพรีวิวสูตรแบบสด</p>

        <!-- Mode -->
        <div class="row" role="group" aria-label="โหมด INDEX Builder">
          <label class="btn small ghost"><input type="radio" name="idxMode" id="idxModeBasic" checked> พื้นฐาน</label>
          <label class="btn small ghost"><input type="radio" name="idxMode" id="idxModeDynamic"> ไดนามิก (MATCH)</label>
          <span class="right muted">Tip: ติ๊ก <span class="code">$</span> เพื่อล็อกช่วง เวลา Copy สูตร</span>
        </div>

        <!-- Common -->
        <div class="form-grid" style="margin-top:10px">
          <div class="field fg-6">
            <label for="idxRange"><b>ช่วงข้อมูล (Range)</b></label>
            <input id="idxRange" type="text" placeholder="เช่น A2:D100 หรือ A:D">
          </div>
          <div class="field fg-3">
            <label for="idxSheet">ชื่อชีต (ถ้ามี)</label>
            <input id="idxSheet" type="text" placeholder="เช่น Sales 2024">
          </div>
          <div class="field fg-3">
            <label>&nbsp;</label>
            <label class="row" style="gap:8px"><input id="idxAbs" type="checkbox"> อ้างอิงแบบ $ คงที่</label>
          </div>
        </div>

        <!-- BASIC inputs -->
        <div id="idxBasic" class="form-grid" style="margin-top:6px">
          <div class="field fg-6">
            <label for="idxRow"><b>แถว (row_num)</b></label>
            <input id="idxRow" type="number" min="1" placeholder="เช่น 2">
          </div>
          <div class="field fg-6">
            <label for="idxCol"><b>คอลัมน์ (column_num)</b></label>
            <input id="idxCol" type="number" min="1" placeholder="เช่น 4">
          </div>
        </div>

        <!-- DYNAMIC (MATCH) inputs -->
        <div id="idxDynamic" class="form-grid" style="display:none; margin-top:6px">
          <div class="field fg-6">
            <label for="idxLookupRow"><b>หาแถวด้วย MATCH</b> — ค่าที่จะค้นหา</label>
            <input id="idxLookupRow" type="text" placeholder='เช่น "East" หรือ E2'>
          </div>
          <div class="field fg-6">
            <label for="idxLookupRowRange">ช่วงค้นหาแถว</label>
            <input id="idxLookupRowRange" type="text" placeholder="เช่น A:A หรือ A2:A100">
          </div>
          <div class="field fg-6">
            <label for="idxLookupCol"><b>หาคอลัมน์ด้วย MATCH</b> — ค่าที่จะค้นหา</label>
            <input id="idxLookupCol" type="text" placeholder='เช่น "Sales" หรือ C1'>
          </div>
          <div class="field fg-6">
            <label for="idxLookupColRange">ช่วงค้นหาคอลัมน์</label>
            <input id="idxLookupColRange" type="text" placeholder="เช่น 1:1 หรือ A1:D1">
          </div>
        </div>

        <!-- Actions -->
        <div class="row" style="margin-top:8px">
          <div class="row" style="gap:8px">
            <button class="btn accent" id="idxCopy">คัดลอกสูตร</button>
            <button class="btn" id="idxExample">ตัวอย่าง</button>
            <button class="btn ghost" id="idxReset">รีเซ็ต</button>
          </div>
          <span class="right muted">พรีวิวจะแสดงอัตโนมัติเมื่อพิมพ์</span>
        </div>

        <!-- Output -->
        <div id="idxOutput" class="panel" style="margin-top:12px; word-break: break-all"></div>
      </div>
    </section>

    <!-- Datasets -->
    <section id="datasets" hidden>
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">ชุดข้อมูลตัวอย่าง & อัปโหลด CSV</h2>
          <div class="right row">
            <button class="btn" id="loadSample">โหลดชุดตัวอย่าง</button>
            <label class="btn">
              อัปโหลด CSV
              <input type="file" id="csvFile" accept=".csv,text/csv" hidden />
            </label>
            <button class="btn ghost" id="downloadCsv">ดาวน์โหลด CSV ตัวอย่าง</button>
          </div>
        </div>
        <div id="dataMeta" class="muted" style="margin-top:4px"></div>
        <div style="margin-top:12px; overflow:auto; max-height: 60vh">
          <table id="dataTable"></table>
        </div>
      </div>

      <div class="panel">
        <h4 style="margin-top:0">Practice Tasks (ตรวจรูปแบบคำตอบ)</h4>
        <ol id="dataTasks" style="padding-left: 20px"></ol>
      </div>
    </section>

    <!-- Explain -->
    <section id="explain" hidden>
      <div class="panel">
        <h2 style="margin-top:0">อธิบายสูตร (Detailed Explain)</h2>
        <div class="form-grid">
          <div class="field fg-12">
            <label for="explainInput">วางสูตร Excel ของคุณ</label>
            <textarea id="explainInput" rows="4" placeholder='เช่น =SUMIFS(C:C, A:A, "East", B:B, "Apple")'></textarea>
          </div>
          <div class="field fg-6">
            <label for="explainMode">โหมดคำอธิบาย</label>
            <select id="explainMode">
              <option value="detailed">ละเอียด (Step-by-step)</option>
              <option value="basic">แบบย่อ (สรุปใจความ)</option>
            </select>
          </div>
          <div class="field fg-6">
            <label>&nbsp;</label>
            <div class="row">
              <label class="row" style="gap:8px"><input type="checkbox" id="showPitfalls" checked> แสดงข้อควรระวัง</label>
              <label class="row" style="gap:8px"><input type="checkbox" id="showAlternatives" checked> แสดงทางเลือก/ทริก</label>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn accent" id="doExplain">อธิบายสูตร</button>
          <button class="btn ghost" id="copyExplain">คัดลอกคำอธิบาย</button>
          <span class="muted">Tip: กด <span class="code">Ctrl + Enter</span> เพื่ออธิบายทันที</span>
        </div>

        <div id="explainOut" class="panel ex" style="margin-top:14px"></div>
      </div>
    </section>
  </main>

  <footer>
    <div>© 2025 Excel Formula Coach • ทำด้วยใจให้สายวิเคราะห์ข้อมูล 🧩</div>
    <div>กด <span class="code">?</span> เพื่อดูคีย์ลัด • <span class="code">/</span> โฟกัสค้นหา • <span class="code">Ctrl + K</span> Command Palette</div>
  </footer>

  <!-- Dialogs -->
  <dialog id="formulaDialog" aria-label="รายละเอียดสูตร">
    <div class="modal-head">
      <div style="font-weight:800" id="fTitle">Formula</div>
      <button class="close" data-close>✖</button>
    </div>
    <div class="modal-body" id="fBody"></div>
  </dialog>

  <dialog id="cmdDialog" aria-label="Command Palette">
    <div class="modal-head">
      <div style="font-weight:800">Command Palette</div>
      <button class="close" data-close>✖</button>
    </div>
    <div class="modal-body">
      <input id="cmdInput" type="search" placeholder="ค้นหาคำสั่ง… (เช่น go quiz, toggle dark, export)" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)">
      <ul id="cmdList" style="list-style:none; margin:10px 0 0 0; padding:0; max-height: 50vh; overflow:auto"></ul>
    </div>
  </dialog>

  <dialog id="helpDialog" aria-label="คีย์ลัดและวิธีใช้">
    <div class="modal-head">
      <div style="font-weight:800">คีย์ลัด</div>
      <button class="close" data-close>✖</button>
    </div>
    <div class="modal-body">
      <ul>
        <li><span class="code">/</span> โฟกัสค้นหา</li>
        <li><span class="code">Ctrl + K</span> เปิด Command Palette</li>
        <li><span class="code">g t</span> ไปหน้า Tutorial • <span class="code">g q</span> หน้า Quiz • <span class="code">g p</span> Practice • <span class="code">g d</span> Datasets • <span class="code">g e</span> Explain</li>
        <li><span class="code">?</span> แสดงหน้านี้</li>
        <li><span class="code">Ctrl + Enter</span> อธิบายสูตร</li>
      </ul>
    </div>
  </dialog>

  <script>
    // Helpers
    const $ = (sel, el = document) => el.querySelector(sel);
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
    const h = (tag, props = {}, ...children) => {
      const el = Object.assign(document.createElement(tag), props);
      for (const c of children) el.append(c?.nodeType ? c : document.createTextNode(c));
      return el;
    };
    const on = (el, evt, fn) => el.addEventListener(evt, fn);
    const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}};
    const LSK = (k) => `efc_${k}`;
    const save = (k,v)=> localStorage.setItem(LSK(k), JSON.stringify(v));
    const load = (k, d=null)=> { try { const v=localStorage.getItem(LSK(k)); return v?JSON.parse(v):d } catch { return d } };
    const copy = async (txt)=> { try{ await navigator.clipboard.writeText(txt); toast("คัดลอกแล้ว ✅") }catch{ alert(txt) } };
    const toast = (msg)=> {
      const t = h('div', {textContent: msg, style: `
        position: fixed; left: 50%; transform: translateX(-50%);
        bottom: 22px; background: var(--ui); color: var(--text);
        border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
        padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow); z-index: 80;
      `});
      document.body.append(t); setTimeout(()=> t.remove(), 1800);
    };

    // Theme
    const themeBtn = $('#themeBtn');
    const applyTheme = () => {
      const theme = load('theme','dark');
      document.documentElement.classList.toggle('light', theme==='light');
      themeBtn.textContent = theme==='light' ? '🌞' : '🌓';
    };
    on(themeBtn,'click', ()=>{
      const next = (load('theme','dark')==='dark') ? 'light' : 'dark';
      save('theme', next); applyTheme();
    });
    applyTheme();

    // Data: Formulas Catalog
    const FORMULAS = [
      { id:'XLOOKUP', name:'XLOOKUP', cat:'Lookup', level:'Intermediate',
        desc:'ค้นหาค่าในคอลัมน์/แถวหนึ่งแล้วคืนค่าจากอีกคอลัมน์/แถว',
        examples:['=XLOOKUP(A2, SKU!A:A, SKU!D:D, "N/A")','=XLOOKUP(E2, A:A, B:B,, -1)'],
        tips:['แทนที่ VLOOKUP/HLOOKUP ได้', 'รองรับค้นหาย้อนหลังและค่าหากไม่พบ'] },
      { id:'VLOOKUP', name:'VLOOKUP', cat:'Lookup', level:'Beginner',
        desc:'ค้นหาแนวตั้งจากคอลัมน์ซ้ายสุดของตาราง',
        examples:['=VLOOKUP(A2, A:D, 4, FALSE)'],
        tips:['คอลัมน์ผลลัพธ์ต้องอยู่ขวาของ lookup-key', 'ใช้ FALSE เพื่อการจับคู่อย่างแม่นยำ'] },
      { id:'INDEX_MATCH', name:'INDEX + MATCH', cat:'Lookup', level:'Intermediate',
        desc:'จับคู่ค่าด้วย MATCH แล้วดึงค่าด้วย INDEX (ยืดหยุ่นกว่าการระบุดัชนีคอลัมน์)',
        examples:['=INDEX(D:D, MATCH(A2, A:A, 0))'],
        tips:['เดินซ้าย/ขวาได้อิสระ', 'เหมาะกับตารางที่อาจสลับคอลัมน์'] },
      { id:'SUMIF', name:'SUMIF', cat:'Math', level:'Beginner',
        desc:'รวมค่าที่ตรงตามเงื่อนไขเดียว', examples:['=SUMIF(A:A, ">100", B:B)'], tips:['ถ้ามีหลายเงื่อนไขใช้ SUMIFS'] },
      { id:'SUMIFS', name:'SUMIFS', cat:'Math', level:'Intermediate',
        desc:'รวมค่าที่ตรงกับหลายเงื่อนไข', examples:['=SUMIFS(C:C, A:A, "East", B:B, "Apple")'], tips:['ลำดับอาร์กิวเมนต์: ช่วงผลรวม, ช่วงเงื่อนไข1, เงื่อนไข1, ...'] },
      { id:'COUNTIFS', name:'COUNTIFS', cat:'Stat', level:'Beginner',
        desc:'นับจำนวนแถวที่ตรงกับหลายเงื่อนไข', examples:['=COUNTIFS(A:A, "East", B:B, "Apple")'], tips:['คล้าย SUMIFS แต่เป็นการนับ'] },
      { id:'IF', name:'IF', cat:'Logical', level:'Beginner',
        desc:'ตรวจเงื่อนไข ถ้าจริงให้ค่า A ถ้าเท็จให้ค่า B', examples:['=IF(A2>=60, "ผ่าน", "ตก")'], tips:['ใช้ร่วมกับ AND/OR เพื่อสร้างเงื่อนไขซ้อน'] },
      { id:'AND_OR', name:'AND / OR', cat:'Logical', level:'Intermediate',
        desc:'ตรรกะหลายเงื่อนไข (AND ต้องจริงทั้งหมด, OR จริงอย่างน้อยหนึ่ง)', examples:['=AND(A2>0, B2<100)','=OR(C2="Yes", D2="Y")'], tips:['ใช้ห่อกับ IF เพื่อแตกแขนง'] },
      { id:'TEXTJOIN', name:'TEXTJOIN', cat:'Text', level:'Intermediate',
        desc:'เชื่อมข้อความหลายส่วนพร้อมตัวคั่น', examples:['=TEXTJOIN("-", TRUE, A2:C2)'], tips:['ตั้ง ignore_empty=TRUE เพื่อข้ามช่องว่าง'] },
      { id:'LEFT_RIGHT_LEN', name:'LEFT / RIGHT / LEN', cat:'Text', level:'Beginner',
        desc:'ตัดข้อความซ้าย/ขวา และหาความยาว', examples:['=LEFT(A2, 3)','=RIGHT(A2, 4)','=LEN(A2)'], tips:['ใช้ร่วมกับ FIND/MID เพื่อดึงส่วนย่อย'] },
      { id:'DATE_TIME', name:'TODAY / EOMONTH', cat:'Date', level:'Intermediate',
        desc:'วันที่ปัจจุบัน, ปลายเดือน', examples:['=TODAY()','=EOMONTH(TODAY(), -1)'], tips:['วันที่คือเลขลำดับวัน — จัดรูปแบบการแสดงผลตามต้องการ'] },
      { id:'FILTER', name:'FILTER', cat:'Array', level:'Advanced',
        desc:'กรองช่วงข้อมูลตามเงื่อนไข ส่งผลลัพธ์แบบ dynamic array', examples:['=FILTER(A2:D100, (A2:A100="East")*(B2:B100="Apple"))'], tips:['ใช้ * แทน AND และ + แทน OR ในเงื่อนไขหลายส่วน'] },
      { id:'UNIQUE_SORT', name:'UNIQUE / SORT', cat:'Array', level:'Intermediate',
        desc:'ดึงค่าที่ไม่ซ้ำ และจัดเรียงผลลัพธ์', examples:['=SORT(UNIQUE(A2:A100))'], tips:['ทำงานคู่กับ FILTER ได้ดี'] },
      { id:'LET', name:'LET', cat:'Other', level:'Advanced',
        desc:'ตั้งชื่อตัวแปรชั่วคราวในสูตรเพื่ออ่านง่ายและเร็วกว่าซ้ำคำนวณ', examples:['=LET(t, SUMIFS(C:C, A:A, "East"), t * 1.07)'], tips:['ตั้งชื่อให้สื่อความหมาย แล้วใช้ซ้ำได้ในสูตรเดียวกัน'] },
      { id:'LAMBDA', name:'LAMBDA', cat:'Other', level:'Advanced',
        desc:'สร้างฟังก์ชันของคุณเองในชีต', examples:['=LAMBDA(x, x^2)(5)'], tips:['ใช้ Name Manager ตั้งชื่อและเรียกใช้เหมือนฟังก์ชันปกติ'] },
    ];
    const CATS = ['ทุกหมวดหมู่','Lookup','Math','Stat','Logical','Text','Date','Array','Other'];

    // Build Category Chips
    const catChips = $('#catChips'); let currentCat = load('cat','ทุกหมวดหมู่');
    const renderChips = () => {
      catChips.innerHTML = '';
      CATS.forEach(cat=>{
        const b = h('button',{className:'chip'+(currentCat===cat?' active':''), textContent: cat});
        on(b,'click',()=>{ currentCat=cat; save('cat',cat); renderChips(); renderGrid() });
        catChips.append(b);
      });
    };
    renderChips();

    // Search + Grid (Tutorial)
    const q = $('#q'), grid = $('#formulaGrid'), resultCount = $('#resultCount');
    const match = (s, q) => s.toLowerCase().includes(q.trim().toLowerCase());
    const formulaCard = (f) => {
      const el = h('div',{className:'card'});
      el.append(
        h('div',{className:'row'},
          h('h3', {textContent: f.name, style:'margin:0'}),
          h('span', {className:'pill'}, f.cat),
          h('span', {className:'pill'}, f.level)
        ),
        h('div',{className:'muted'}, f.desc),
        h('div',{style:'margin-top:10px; display:flex; gap:8px; flex-wrap: wrap'},
          ...f.examples.slice(0,2).map(ex => {
            const b = h('button',{className:'btn ghost'}, 'คัดลอก ', h('span',{className:'code',textContent:ex}));
            on(b,'click',()=>copy(ex));
            return b;
          }),
          h('button',{className:'btn right', title:'ดูรายละเอียด'},'รายละเอียด ▶')
        )
      );
      el.querySelector('.right')?.addEventListener('click',()=> openFormulaDialog(f));
      return el;
    };
    const renderGrid = () => {
      const term = q.value.trim();
      let list = FORMULAS.filter(f=> currentCat==='ทุกหมวดหมู่' || f.cat===currentCat);
      if (term) list = list.filter(f=> match(f.name, term) || match(f.desc, term) || f.examples.some(e=>match(e,term)) );
      resultCount.textContent = `${list.length} สูตร`;
      grid.innerHTML = ''; for (const f of list) grid.append(formulaCard(f));
    };
    on(q,'input', debounce(renderGrid, 150));
    on(document,'keydown', (e)=>{ if (e.key === '/') { e.preventDefault(); q.focus() } });
    const openFormulaDialog = (f) => {
      $('#fTitle').textContent = f.name + ' · ' + f.cat + ' · ' + f.level;
      const body = $('#fBody'); body.innerHTML = '';
      body.append(h('p',{}, f.desc), h('h4',{}, 'ตัวอย่าง'), h('ul',{}, ...f.examples.map(x=>h('li',{}, h('span',{className:'code',textContent:x})))));
      if (f.tips?.length){ body.append(h('h4',{}, 'เคล็ดลับ'), h('ul',{}, ...f.tips.map(t=>h('li',{},t)))); }
      $('#formulaDialog').showModal();
    };
    $$('#formulaDialog [data-close]').forEach(b=> on(b,'click', ()=> $('#formulaDialog').close() ));
    renderGrid();

    // Tabs
    const tabs = $$('.tab'); let currentTab = load('tab','tutorial');
    const showTab = (id) => {
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===id));
      $$('main > section').forEach(s=> s.hidden = s.id !== id);
      currentTab = id; save('tab', id);
    };
    tabs.forEach(t=> on(t,'click', ()=> showTab(t.dataset.tab)));
    showTab(currentTab);

    // Export / Import / Reset
    $('#exportBtn').onclick = () => {
      const data = {};
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i); if (k.startsWith('efc_')) data[k]=localStorage.getItem(k);
      }
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = h('a',{href: URL.createObjectURL(blob), download: 'efc_backup.json'}); a.click();
      toast('บันทึกไฟล์ efc_backup.json แล้ว');
    };
    $('#importFile').onchange = async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const txt = await f.text();
      try {
        const data = JSON.parse(txt);
        Object.entries(data).forEach(([k,v])=> localStorage.setItem(k, v));
        toast('นำเข้าข้อมูลแล้ว ✅'); location.reload();
      } catch(err){ alert('ไฟล์ไม่ถูกต้อง'); }
    };
    $('#resetBtn').onclick = ()=>{
      if (confirm('ล้างข้อมูลทั้งหมดของ Excel Formula Coach บนอุปกรณ์นี้?')) {
        Object.keys(localStorage).filter(k=>k.startsWith('efc_')).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }
    };

    // Command Palette
    const cmdDialog = $('#cmdDialog'), cmdInput = $('#cmdInput'), cmdList = $('#cmdList');
    const COMMANDS = [
      {label:'Go: Tutorial', run:()=>showTab('tutorial')},
      {label:'Go: Quiz', run:()=>showTab('quiz')},
      {label:'Go: Practice', run:()=>showTab('practice')},
      {label:'Go: Playground', run:()=>showTab('playground')},
      {label:'Go: Datasets', run:()=>showTab('datasets')},
      {label:'Go: Explain', run:()=>showTab('explain')},
      {label:'Start: 10-question quiz', run:()=>{ showTab('quiz'); startQuiz() }},
      {label:'Toggle: Dark/Light', run:()=> $('#themeBtn').click() },
      {label:'Export data', run:()=> $('#exportBtn').click() },
      {label:'Import data', run:()=> $('#importFile').click() },
      {label:'Reset data', run:()=> $('#resetBtn').click() },
      {label:'Help / Shortcuts', run:()=> $('#helpDialog').showModal() },
      {label:'Open: INDEX Builder (Playground)', run:()=>{ showTab('playground'); document.getElementById('indexBuilderPanel')?.scrollIntoView({behavior:'smooth', block:'start'}) }},
    ];
    const openCmd = ()=>{ cmdDialog.showModal(); cmdInput.value=''; renderCmd('') };
    const closeCmd = ()=> cmdDialog.close();
    const renderCmd = (q)=> {
      cmdList.innerHTML = '';
      const items = COMMANDS.filter(c=> c.label.toLowerCase().includes(q.toLowerCase()));
      items.forEach(c=>{
        const li = h('li',{style:'padding:10px 6px; border-bottom:1px dashed color-mix(in oklab, var(--muted) 25%, transparent); cursor:pointer'}, c.label);
        on(li,'click', ()=>{ c.run(); closeCmd() });
        cmdList.append(li);
      });
      if (!items.length) cmdList.append(h('li',{className:'muted', style:'padding:10px 6px'}, 'ไม่พบคำสั่ง'));
    };
    on(cmdInput,'input', ()=> renderCmd(cmdInput.value));
    $$('#cmdDialog [data-close]').forEach(b=> on(b,'click', closeCmd));
    on(document,'keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd() }
      if (e.key === '?'){ e.preventDefault(); $('#helpDialog').showModal() }
      if (e.key === 'Escape'){ [cmdDialog,$('#helpDialog'),$('#formulaDialog')].forEach(d=> d.open && d.close()) }
      if (e.key==='g'){
        let seq='g '; const handler=(ev)=>{
          seq += ev.key; if (seq.endsWith('g t')) showTab('tutorial');
          if (seq.endsWith('g q')) showTab('quiz');
          if (seq.endsWith('g p')) showTab('practice');
          if (seq.endsWith('g d')) showTab('datasets');
          if (seq.endsWith('g e')) showTab('explain');
          document.removeEventListener('keydown', handler);
        };
        document.addEventListener('keydown', handler, {once:true});
      }
    });

    // Quiz
    const quizArea = $('#quizArea'); const quizLevel = $('#quizLevel');
    $('#startQuiz').onclick = ()=> startQuiz();
    const pick = (arr,n)=> arr.sort(()=>Math.random()-0.5).slice(0,n);
    const QUESTIONS_POOL = [
      ()=>({type:'mc', q:'ต้องการรวมยอดขายที่ Region = "East" และ Product = "Apple" ควรใช้ฟังก์ชันใด?', choices:['SUMIF','SUMIFS','FILTER','XLOOKUP'], answer: 'SUMIFS'}),
      ()=>({type:'mc', q:'ต้องการค้นหาชื่อจากรหัส SKU โดยมีคอลัมน์ผลลัพธ์อยู่ซ้ายของรหัส ใช้สูตรใดเหมาะสุด?', choices:['VLOOKUP','INDEX + MATCH','TEXTJOIN','COUNTIFS'], answer: 'INDEX + MATCH'}),
      ()=>({type:'fill', q:'เติมรูปแบบฟังก์ชันให้ถูกต้อง: XLOOKUP(lookup_value, lookup_array, return_array, [if_not_found], [match_mode], [search_mode])', answerPattern:/^\s*XLOOKUP\s*\(\s*lookup_value\s*,\s*lookup_array\s*,\s*return_array/i}),
      ()=>({type:'read', q:'สูตรนี้ทำอะไร: =TEXTJOIN("-", TRUE, A2:C2)', answer: 'เชื่อมค่าในช่วง A2:C2 โดยใช้ "-" และข้ามช่องว่าง'}),
      ()=>({type:'mc', q:'ต้องการรายการ Region ที่ไม่ซ้ำและเรียงจาก A→Z ใช้อะไร?', choices:['UNIQUE','SORT','SORT(UNIQUE(...))','FILTER'], answer: 'SORT(UNIQUE(...))'}),
      ()=>({type:'mc', q:'ต้องการกรองแถวที่ยอดขาย > 1000 และ Region = "West" แบบ Dynamic Array', choices:['FILTER','SUMIFS','COUNTIF','IF'], answer: 'FILTER'}),
      ()=>({type:'mc', q:'ต้องการคำนวณปลายเดือนที่แล้ว ควรใช้?', choices:['EOMONTH(TODAY(), -1)','TODAY()-30','DATE(YEAR(TODAY()),MONTH(TODAY()),0)','TEXTJOIN'], answer: 'EOMONTH(TODAY(), -1)'}),
      ()=>({type:'read', q:'สูตรนี้ทำอะไร: =IF(AND(A2>0, B2<100),"OK","CHECK")', answer: 'ถ้า A2 > 0 และ B2 < 100 ให้ "OK" ไม่เช่นนั้นให้ "CHECK"'})
    ];
    function buildQuizQuestions(level){ return pick(QUESTIONS_POOL.map(f=>f()), 10); }
    function startQuiz(){ const qs = buildQuizQuestions(quizLevel.value); save('last_quiz', qs); renderQuiz(qs); }
    function renderQuiz(qs){
      quizArea.innerHTML = ''; let answers = [];
      qs.forEach((it, idx)=>{
        const item = h('div',{className:'card'});
        item.append(h('div',{className:'pill'}, `ข้อ ${idx+1}/${qs.length}`));
        item.append(h('h3',{}, it.q));
        if (it.type==='mc'){
          const grp = `q${idx}`;
          it.choices.forEach(ch=>{
            const label = h('label',{style:'display:flex; gap:10px; align-items:center; padding:6px 0; cursor:pointer'});
            const r = h('input',{type:'radio', name:grp, value:ch});
            label.append(r, h('span',{}, ch)); item.append(label);
          });
        } else if (it.type==='fill'){
          const inp = h('input',{type:'text', placeholder:'พิมพ์รูปแบบฟังก์ชันให้ถูกต้อง', style:'width:100%; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); item.append(inp);
        } else if (it.type==='read'){
          const inp = h('textarea',{rows:2, placeholder:'พิมพ์คำอธิบายสั้น ๆ', style:'width:100%; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); item.append(inp);
        }
        quizArea.append(item);
      });
      const submit = h('button',{className:'btn accent', style:'margin-top:12px'}, 'ส่งคำตอบ');
      on(submit,'click', ()=>{
        let score=0;
        $$('#quizArea .card').forEach((card,i)=>{
          const it = qs[i]; let ok=false;
          if (it.type==='mc'){
            const v = card.querySelector('input[type=radio]:checked')?.value; ok = v===it.answer;
          } else if (it.type==='fill'){
            const v = card.querySelector('input')?.value || ''; ok = it.answerPattern.test(v);
          } else if (it.type==='read'){
            const v = (card.querySelector('textarea')?.value || '').toLowerCase(); ok = ['เชื่อม','กรอง','รวม','ค้นหา','ถ้า'].some(k=> v.includes(k));
          }
          if (ok) score++; card.style.outline = `2px solid ${ok? 'var(--ok)':'var(--danger)'}`;
        });
        const pct = Math.round(score/qs.length*100); toast(`คุณได้ ${pct}%`);
        if (pct>=80){ confettiBurst(); awardBadge() }
        const hist = load('quiz_hist',[]); hist.push({ts:Date.now(), pct}); save('quiz_hist', hist);
      });
      quizArea.append(submit);
    }
    function awardBadge(){ const key='badge_80'; if (!load(key,false)){ save(key,true); toast('🏅 ปลดล็อก Badge: Quiz 80%'); } }

    // Practice
    const practiceArea = $('#practiceArea'), practiceRefill = $('#practiceRefill');
    function genPracticeCards(){
      const picks = pick(FORMULAS, 6); practiceArea.innerHTML = '';
      picks.forEach(f=>{
        const c = h('div',{className:'card'});
        c.append(h('div',{className:'row'}, h('h3',{}, f.name), h('span',{className:'pill'}, f.cat), h('span',{className:'pill'}, f.level)));
        c.append(h('div',{className:'muted'}, f.desc));
        const ans = h('input',{type:'text', placeholder:'พิมพ์สูตรตัวอย่างของคุณเอง แล้วกดตรวจ', style:'width:100%; margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); 
        const row = h('div',{className:'row', style:'margin-top:8px'});
        const check = h('button',{className:'btn accent'}, 'ตรวจคำตอบ');
        const give = h('button',{className:'btn'}, 'ดูตัวอย่าง');
        const stat = h('span',{className:'right muted'});
        row.append(check, give, stat); c.append(ans, row);
        on(check,'click', ()=>{
          const v = ans.value.toUpperCase(); const ok = v.includes(f.name.split(' ')[0]);
          c.style.outline = `2px solid ${ok? 'var(--ok)':'var(--danger)'}`; stat.textContent = ok? 'ดีมาก! ✅' : 'ยังไม่ตรง ลองใหม่ดูนะ';
          const k = 'practice_'+f.id; const curr = load(k,{ok:0, fail:0}); ok ? curr.ok++ : curr.fail++; save(k,curr);
        });
        on(give,'click', ()=>{ alert('ตัวอย่าง:\n' + f.examples.join('\n')); });
        practiceArea.append(c);
      });
    }
    practiceRefill.onclick = genPracticeCards; genPracticeCards();

    // Playground (Mini Evaluator)
    function evalSimple(expr){
      const s = expr.trim().replace(/^=/,'').toUpperCase();
      const fnMatch = /^([A-Z]+)\s*\((.*)\)$/.exec(s);
      if (!fnMatch) throw new Error('รูปแบบไม่รองรับ ลองเริ่มด้วย =SUM(...), =TEXTJOIN(...), ...');
      const fn = fnMatch[1]; const args = splitArgs(fnMatch[2]).map(x => parseArg(x));
      switch(fn){
        case 'SUM': return args.reduce((a,b)=>a+toNum(b),0);
        case 'AVERAGE': return args.reduce((a,b)=>a+toNum(b),0)/args.length;
        case 'MIN': return Math.min(...args.map(toNum));
        case 'MAX': return Math.max(...args.map(toNum));
        case 'LEN': return (args[0]+'').length;
        case 'LEFT': return (args[0]+'').slice(0, toNum(args[1]||0));
        case 'RIGHT': { const t=(args[0]+''); const n=toNum(args[1]||0); return t.slice(t.length-n) }
        case 'UPPER': return (args[0]+'').toUpperCase();
        case 'LOWER': return (args[0]+'').toLowerCase();
        case 'CONCAT': return args.map(String).join('');
        case 'TEXTJOIN': {
          const [delim, ignoreEmpty, ...rest] = args;
          const joiner = String(delim ?? '');
          const items = rest.flatMap(x => Array.isArray(x)? x : [x]).map(String);
          const out = (ignoreEmpty ? items.filter(v=>v!=='') : items).join(joiner);
          return out;
        }
        default: throw new Error('ฟังก์ชันนี้ไม่ได้อยู่ใน Mini Evaluator');
      }
    }
    function splitArgs(s){
      const out=[], buf=[]; let depth=0, inStr=false, quote='"';
      for (let i=0;i<s.length;i++){
        const c = s[i], p = s[i-1];
        if ((c=='"'||c=="'") && p!=='\\'){ if (inStr && c===quote) inStr=false; else if(!inStr){ inStr=true; quote=c } }
        if (!inStr && c==='(') depth++;
        if (!inStr && c===')' && depth>0) depth--;
        if (!inStr && depth===0 && c===','){ out.push(buf.join('').trim()); buf.length=0; continue; }
        buf.push(c);
      }
      if (buf.length) out.push(buf.join('').trim());
      return out;
    }
    function parseArg(x){
      if (/^".*"$/.test(x) || /^'.*'$/.test(x)) return x.slice(1,-1);
      if (/^\d+(\.\d+)?$/.test(x)) return Number(x);
      if (/^{.*}$/.test(x)) return x.slice(1,-1).split(';');
      return x;
    }
    const toNum = (v)=> typeof v==='number' ? v : Number(String(v).replace(/[^0-9\.\-]/g,''))||0;
    on($('#runPlay'),'click', ()=>{
      const inp = $('#playInput').value;
      try { const res = evalSimple(inp);
        $('#playResult').innerHTML = `<div class="card"><b>ผลลัพธ์:</b> <span class="code">${String(res)}</span></div>`;
      } catch(e){
        $('#playResult').innerHTML = `<div class="card" style="border-color: var(--danger)"><b>ผิดพลาด:</b> ${e.message}</div>`;
      }
    });

    // INDEX Builder (Simplified)
    (function(){
      const el = {
        range: $('#idxRange'), sheet: $('#idxSheet'), abs: $('#idxAbs'),
        row: $('#idxRow'), col: $('#idxCol'),
        modeBasic: $('#idxModeBasic'), modeDyn: $('#idxModeDynamic'),
        basicBox: $('#idxBasic'), dynBox: $('#idxDynamic'),
        lookupRow: $('#idxLookupRow'), lookupRowRange: $('#idxLookupRowRange'),
        lookupCol: $('#idxLookupCol'), lookupColRange: $('#idxLookupColRange'),
        out: $('#idxOutput'), copy: $('#idxCopy'), ex: $('#idxExample'), reset: $('#idxReset')
      };
      const escHtml = (s) => String(s).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
      const needsQuote = (v) => {
        const s = (v||'').trim();
        if (!s) return false;
        if (/^".*"$/.test(s) || /^'.*'$/.test(s)) return false;
        if (/^-?\d+(\.\d+)?$/.test(s)) return false;
        if (/^[A-Za-z]+\d+(:[A-Za-z]+\d+)?$/.test(s)) return false; // A1 or A1:B2
        if (/^[A-Za-z]+:[A-Za-z]+$/.test(s) || /^\d+:\d+$/.test(s)) return false; // A:D or 1:1
        return true;
      };
      const quoteVal = (v) => needsQuote(v) ? `"${String(v).replace(/"/g,'""')}"` : v;
      const escapeSheet = (name) => `'${String(name).replace(/'/g, "''")}'`;

      const absolutizeToken = (t) => {
        t = t.trim();
        if (/^[A-Za-z]+\d+$/.test(t)) { const [,c,r] = t.match(/^([A-Za-z]+)(\d+)$/); return `$${c.toUpperCase()}$${r}`; }
        if (/^[A-Za-z]+$/.test(t)) return `$${t.toUpperCase()}`; // A:D or A:A side
        if (/^\d+$/.test(t)) return `$${t}`; // 1:1
        return t;
      };
      const absolutizeRange = (rng) => {
        const parts = rng.split(':').map(s=>s.trim());
        if (parts.length === 1) return absolutizeToken(parts[0]);
        return absolutizeToken(parts[0]) + ':' + absolutizeToken(parts[1]);
      };

      function showMode(){
        const dyn = el.modeDyn.checked;
        el.basicBox.style.display = dyn ? 'none' : '';
        el.dynBox.style.display = dyn ? '' : 'none';
      }

      function build(){
        let range = (el.range.value || '').trim();
        const sheet = (el.sheet.value || '').trim();
        const isAbs = !!el.abs.checked;
        const dyn = el.modeDyn.checked;

        if (!range){
          el.out.innerHTML = `<div class="muted">พิมพ์ <span class="code">ช่วงข้อมูล</span> ก่อน เช่น <span class="code">A2:D100</span> หรือ <span class="code">A:D</span></div>`;
          return '';
        }
        if (isAbs){ range = range.split(',').map(r => absolutizeRange(r.trim())).join(','); }
        if (sheet) range = `${escapeSheet(sheet)}!${range}`;

        let rowArg = (el.row.value || '').trim();
        let colArg = (el.col.value || '').trim();

        if (dyn){
          // row by MATCH
          const rv = quoteVal((el.lookupRow.value || '').trim());
          let rr = (el.lookupRowRange.value || '').trim() || 'A:A';
          if (isAbs) rr = absolutizeRange(rr);
          if (sheet) rr = `${escapeSheet(sheet)}!${rr}`;
          rowArg = `MATCH(${rv}, ${rr}, 0)`;

          // col by MATCH
          const cv = quoteVal((el.lookupCol.value || '').trim());
          let cr = (el.lookupColRange.value || '').trim() || '1:1';
          if (isAbs) cr = absolutizeRange(cr);
          if (sheet) cr = `${escapeSheet(sheet)}!${cr}`;
          colArg = `MATCH(${cv}, ${cr}, 0)`;
        } else {
          if (!rowArg) rowArg = '1';
          if (!colArg) colArg = '1';
        }

        const formula = colArg ? `=INDEX(${range}, ${rowArg}, ${colArg})` : `=INDEX(${range}, ${rowArg})`;
        el.out.innerHTML = `<b>สูตร:</b> <span class="code">${escHtml(formula)}</span>`;
        return formula;
      }

      // Events
      [el.range, el.sheet, el.abs, el.row, el.col, el.lookupRow, el.lookupRowRange, el.lookupCol, el.lookupColRange]
        .forEach(i=> i && on(i,'input', build));
      [el.modeBasic, el.modeDyn].forEach(r => on(r,'change', ()=>{ showMode(); build(); }));

      on(el.copy,'click', ()=>{ const f = build(); if (f) copy(f); });
      on(el.ex,'click', ()=>{
        el.modeDyn.checked = true; showMode();
        el.sheet.value = 'Sales';
        el.range.value = 'A2:D100';
        el.abs.checked = true;
        el.row.value = ''; el.col.value = '';
        el.lookupRow.value = 'East'; el.lookupRowRange.value = 'A:A';
        el.lookupCol.value = 'Sales'; el.lookupColRange.value = '1:1';
        build(); toast('โหลดตัวอย่างแล้ว ✅');
      });
      on(el.reset,'click', ()=>{
        ['range','sheet','row','col','lookupRow','lookupRowRange','lookupCol','lookupColRange'].forEach(k => el[k].value='');
        el.abs.checked = false; el.modeBasic.checked = true; showMode(); build();
      });

      // init
      showMode(); build();
    })();

    // Datasets
    const SAMPLE_CSV = `Region,Product,Qty,Price,Sales
East,Apple,4,3,12
East,Banana,3,2,6
West,Apple,5,3,15
North,Cherry,7,4,28
South,Apple,8,3,24
East,Cherry,2,4,8
West,Banana,10,2,20
North,Apple,6,3,18
South,Banana,9,2,18
East,Apple,12,3,36
West,Cherry,1,4,4
South,Apple,3,3,9
North,Banana,5,2,10
East,Cherry,11,4,44
West,Apple,2,3,6`;
    const dataTable = $('#dataTable'), dataMeta = $('#dataMeta'); const dataTasks = $('#dataTasks');
    $('#loadSample').onclick = ()=> loadCsv(SAMPLE_CSV);
    $('#downloadCsv').onclick = ()=>{ const blob = new Blob([SAMPLE_CSV], {type:'text/csv'}); const a = h('a',{href: URL.createObjectURL(blob), download:'sample_sales.csv'}); a.click(); };
    $('#csvFile').onchange = async (e)=>{ const f = e.target.files[0]; if (!f) return; const txt = await f.text(); loadCsv(txt); };
    function loadCsv(txt){
      const rows = txt.trim().split(/\r?\n/).map(r=> r.split(','));
      const [header, ...data] = rows;
      dataMeta.textContent = `แถวข้อมูล: ${data.length.toLocaleString()} • คอลัมน์: ${header.length}`;
      dataTable.innerHTML = '';
      const thead = h('thead',{}, h('tr',{}, ...header.map(hd=>h('th',{}, hd))));
      const tbody = h('tbody',{}, ...data.map(r=> h('tr',{}, ...r.map(c=> h('td',{}, c)))));
      dataTable.append(thead, tbody); buildDataTasks(header, data);
    }
    function buildDataTasks(header, data){
      dataTasks.innerHTML = '';
      const tasks = [
        {title:'ยอดขายรวมต่อ Region', hint:'ลองใช้ SUMIFS หรือ SUMIF + เงื่อนไข', expect: /SUMIFS?\s*\(/i},
        {title:'ดึงรายการ Region ที่ไม่ซ้ำและเรียง A→Z', hint:'ใช้ UNIQUE ร่วมกับ SORT', expect: /SORT\s*\(\s*UNIQUE\s*\(/i},
        {title:'ดึงเฉพาะแถวที่ Product = "Apple"', hint:'ลอง FILTER ช่วยกรองข้อมูล', expect: /FILTER\s*\(/i},
        {title:'หายอดขายเฉลี่ยของ Apple', hint:'AVERAGEIF/AVERAGEIFS ก็ได้', expect: /(AVERAGEIFS?|AVERAGE)\s*\(/i}
      ];
      tasks.forEach((t,i)=>{
        const li = h('li',{}, h('div',{className:'row'}, h('b',{}, t.title), h('span',{className:'muted'}, ' • Hint: '+t.hint)));
        const inp = h('input',{type:'text', placeholder:'พิมพ์สูตรที่คุณจะใช้…', style:'width:100%; margin-top:6px; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); 
        const btn = h('button',{className:'btn', style:'margin-top:6px'}, 'ตรวจ');
        const status = h('span',{className:'muted', style:'margin-left:10px'});
        btn.onclick = ()=>{ const ok = t.expect.test((inp.value||'').toUpperCase()); status.textContent = ok? '✅ ใช้แนวทางได้ถูกต้อง' : '❌ ยังไม่ตรง ลองดู Hint'; if (ok) confettiBurst(); };
        li.append(inp, btn, status); dataTasks.append(li);
      });
    }

    // =========================================
    // Explain — Deep, Step-by-step Explainer
    // =========================================
    // 1) Function catalog: arguments, defaults, notes, pitfalls
    const FCAT = {
      SUMIF: {
        summary: 'รวมค่าที่ตรงตามเงื่อนไขเดียว',
        args: ['range','criteria','[sum_range]'],
        mapArgs: (args)=> {
          const [range, criteria, sum_range] = args;
          return [
            ['ช่วงตรวจเงื่อนไข (range)', range],
            ['เงื่อนไข (criteria)', criteria],
            ['ช่วงผลรวม (sum_range)', sum_range ?? '(ไม่ระบุ → ใช้ range เดียวกัน)']
          ];
        },
        returns:'จำนวน (เลข)',
        notes:['ถ้าไม่ระบุ sum_range จะรวมค่าจาก range โดยตรง'],
        pitfalls:['ตัวดำเนินการเปรียบเทียบต้องอยู่ในเครื่องหมายคำพูด เช่น '+'"'+'>=100'+'"' ]
      },
      SUMIFS: {
        summary: 'รวมค่าที่ตรงตามหลายเงื่อนไข',
        args: ['sum_range','criteria_range1','criteria1','...'],
        mapArgs: (args)=> {
          const list = [];
          if (args.length) list.push(['ช่วงผลรวม (sum_range)', args[0]]);
          for (let i=1;i<args.length;i+=2){
            list.push([`ช่วงเงื่อนไข${(i+1)/2} (criteria_range${(i+1)/2})`, args[i]]);
            list.push([`เงื่อนไข${(i+1)/2} (criteria${(i+1)/2})`, args[i+1] ?? '(ขาดพารามิเตอร์)']);
          }
          return list;
        },
        returns:'จำนวน (เลข)',
        notes:['จับคู่ทีละคู่ ช่วงเงื่อนไข ↔ เงื่อนไข','ใช้หลายเงื่อนไขแบบ AND (ต้องผ่านทุกเงื่อนไข)'],
        pitfalls:['ช่วงผลรวมและช่วงเงื่อนไขต้องมีขนาดเท่ากัน']
      },
      COUNTIFS: {
        summary:'นับจำนวนแถวที่ตรงกับหลายเงื่อนไข',
        args:['criteria_range1','criteria1','...'],
        mapArgs:(args)=>{
          const list=[];
          for (let i=0;i<args.length;i+=2){
            list.push([`ช่วงเงื่อนไข${(i/2)+1}`, args[i]]);
            list.push([`เงื่อนไข${(i/2)+1}`, args[i+1] ?? '(ขาดพารามิเตอร์)']);
          }
          return list;
        },
        returns:'จำนวน (เลขจำนวนเต็ม)',
        notes:['ใช้หลายเงื่อนไขแบบ AND'],
        pitfalls:['ช่วงต่าง ๆ ต้องยาวเท่ากัน']
      },
      XLOOKUP: {
        summary:'ค้นหาค่าแล้วคืนค่าที่ตรงกัน',
        args:['lookup_value','lookup_array','return_array','[if_not_found]','[match_mode]','[search_mode]'],
        defaults:{ match_mode:0, search_mode:1 },
        mapArgs:(args)=>{
          const [lv, la, ra, inf, mm, sm] = args;
          return [
            ['ค่าที่ต้องการค้นหา (lookup_value)', lv],
            ['ช่วงค้นหา (lookup_array)', la],
            ['ช่วงผลลัพธ์ (return_array)', ra],
            ['ค่าหากไม่พบ (if_not_found)', inf ?? '(ว่าง → #N/A)'],
            ['โหมดจับคู่ (match_mode)', mm ?? '0 (Exact match)'],
            ['โหมดการค้นหา (search_mode)', sm ?? '1 (First-to-last)'],
          ];
        },
        returns:'ค่าที่ตรงกับผลลัพธ์',
        notes:['แทนที่ VLOOKUP/HLOOKUP ได้','รองรับค้นหาย้อนหลัง (search_mode = -1) และ wildcard (*, ?) เมื่อใช้ match_mode = 2'],
        pitfalls:['ขนาดของ lookup_array และ return_array ต้องสอดคล้องกันตามแกนเดียวกัน']
      },
      VLOOKUP:{
        summary:'ค้นหาแนวตั้งจากคอลัมน์ซ้ายสุด',
        args:['lookup_value','table_array','col_index_num','[range_lookup]'],
        defaults:{ range_lookup:false },
        mapArgs:(a)=>{
          const [lv, ta, col, approx] = a;
          return [
            ['ค่าที่ต้องการค้นหา', lv],
            ['ตาราง (table_array)', ta],
            ['ลำดับคอลัมน์ผลลัพธ์ (1=ซ้ายสุด)', col],
            ['จับคู่แบบประมาณ (range_lookup)', approx ?? 'FALSE (แนะนำให้ใช้ FALSE เพื่อแม่นยำ)']
          ];
        },
        returns:'ค่าที่ตรงกับผลลัพธ์',
        notes:['ต้องให้คอลัมน์ค้นหาอยู่ซ้ายสุดของ table_array'],
        pitfalls:['ถ้า range_lookup เป็น TRUE/ละไว้ → ต้องเรียง A→Z ไม่งั้นผลอาจผิด']
      },
      INDEX:{
        summary:'คืนค่าจากตำแหน่งแถว/คอลัมน์ในช่วง',
        args:['array','row_num','[column_num]'],
        mapArgs:(a)=>{
          const [arr, r, c] = a;
          return [
            ['ช่วงข้อมูล (array)', arr],
            ['แถว (row_num)', r ?? '1'],
            ['คอลัมน์ (column_num)', c ?? '1']
          ];
        },
        returns:'ค่าในเซลล์ตามตำแหน่ง'
      },
      MATCH:{
        summary:'หาตำแหน่งของค่าที่ค้นหาในช่วง',
        args:['lookup_value','lookup_array','[match_type]'],
        defaults:{ match_type:1 },
        mapArgs:(a)=>{
          const [lv, la, mt] = a;
          const t = (mt ?? '1') + ' (1=น้อยกว่า, 0=ตรงตัว, -1=มากกว่า)';
          return [
            ['ค่าที่ต้องการค้นหา (lookup_value)', lv],
            ['ช่วงค้นหา (lookup_array)', la],
            ['ชนิดการจับคู่ (match_type)', mt ?? t]
          ];
        },
        returns:'ลำดับที่ (ตำแหน่งเชิงดัชนี)'
      },
      FILTER:{
        summary:'กรองช่วงข้อมูลตามเงื่อนไข → ผลลัพธ์เป็น Dynamic Array',
        args:['array','include','[if_empty]'],
        mapArgs:(a)=>{
          const [arr, inc, empty] = a;
          return [
            ['ช่วงข้อมูล (array)', arr],
            ['เงื่อนไขรวม (include)', inc],
            ['ค่าหากว่าง (if_empty)', empty ?? 'ถ้าไม่ระบุ → #CALC!']
          ];
        },
        returns:'ช่วงผลลัพธ์แบบ Dynamic Array',
        notes:['ใช้ * แทน AND และ + แทน OR เมื่อรวมหลายเงื่อนไข'],
        pitfalls:['ขนาดของ include ต้องยาวเท่ากับแกนที่กรอง']
      },
      UNIQUE:{
        summary:'คืนค่าที่ไม่ซ้ำจากช่วง',
        args:['array','[by_col]','[exactly_once]'],
        mapArgs:(a)=>{
          const [arr, byCol, once] = a;
          return [
            ['ช่วงข้อมูล', arr],
            ['เลือกตามคอลัมน์ (by_col)', byCol ?? 'FALSE'],
            ['เฉพาะค่าที่พบครั้งเดียว (exactly_once)', once ?? 'FALSE']
          ];
        },
        returns:'รายการที่ไม่ซ้ำ'
      },
      SORT:{
        summary:'จัดเรียงช่วงข้อมูล',
        args:['array','[sort_index]','[sort_order]','[by_col]'],
        mapArgs:(a)=>{
          const [arr, idx, ord, byCol] = a;
          return [
            ['ช่วงข้อมูล', arr],
            ['คอลัมน์/แถวที่จะเรียง (sort_index)', idx ?? '1'],
            ['ลำดับ (sort_order)', ord ?? '1 (น้อย→มาก)'],
            ['เรียงตามคอลัมน์ (by_col)', byCol ?? 'FALSE']
          ];
        },
        returns:'ช่วงข้อมูลที่เรียงแล้ว'
      },
      TEXTJOIN:{
        summary:'เชื่อมข้อความด้วยตัวคั่น',
        args:['delimiter','ignore_empty','text1','[text2]','...'],
        mapArgs:(a)=>{
          const [d, ign, ...rest] = a;
          return [
            ['ตัวคั่น (delimiter)', d],
            ['ข้ามค่าว่าง (ignore_empty)', ign],
            ['ข้อความ/ช่วงที่จะเชื่อม', rest.length? rest.join(', ') : '(ยังไม่ได้ระบุ)']
          ];
        },
        returns:'สตริงข้อความ'
      },
      IF:{
        summary:'ตรรกะเงื่อนไข ถ้าจริง → A, เท็จ → B',
        args:['logical_test','value_if_true','[value_if_false]'],
        mapArgs:(a)=>{
          const [t, tr, fa] = a;
          return [
            ['เงื่อนไข (logical_test)', t],
            ['ค่าถ้าเป็นจริง', tr],
            ['ค่าถ้าเป็นเท็จ', fa ?? '"" (ค่าว่าง)']
          ];
        },
        returns:'ค่าใดค่าหนึ่งตามผลลัพธ์ตรรกะ'
      },
      AND:{ summary:'จริงเมื่อทุกเงื่อนไขเป็นจริง', args:['logical1','[logical2]','...'], returns:'TRUE/FALSE' },
      OR:{ summary:'จริงเมื่อมีอย่างน้อยหนึ่งเป็นจริง', args:['logical1','[logical2]','...'], returns:'TRUE/FALSE' },
      LEFT:{ summary:'ตัดอักขระจากซ้าย', args:['text','[num_chars]'], returns:'สตริง' },
      RIGHT:{ summary:'ตัดอักขระจากขวา', args:['text','[num_chars]'], returns:'สตริง' },
      LEN:{ summary:'ความยาวข้อความ', args:['text'], returns:'จำนวนเต็ม' },
      AVERAGE:{ summary:'ค่าเฉลี่ยเลขคณิต', args:['number1','[number2]','...'], returns:'จำนวน' },
      MIN:{ summary:'ค่าต่ำสุด', args:['number1','[number2]','...'], returns:'จำนวน' },
      MAX:{ summary:'ค่าสูงสุด', args:['number1','[number2]','...'], returns:'จำนวน' },
      TODAY:{ summary:'วันที่ปัจจุบัน', args:[], returns:'วันที่ (serial)' },
      EOMONTH:{ summary:'ปลายเดือนที่เลื่อนตามระยะ', args:['start_date','months'], returns:'วันที่ปลายเดือน' },
      LET:{ summary:'ประกาศตัวแปรใช้ภายในสูตร', args:['name1','value1','[name2]','[value2]','...','calculation'], returns:'ผลของ calculation' },
      LAMBDA:{ summary:'นิยามฟังก์ชันแบบกำหนดเอง', args:['[parameter1]','[parameter2]','...','calculation'], returns:'ค่าตามนิยาม' }
    };

    // 2) Parser — สร้างต้นไม้ของสูตร
    function parseFormula(formula){
      let s = String(formula || '').trim();
      if (!s) return null;
      if (s.startsWith('=')) s = s.slice(1);
      let i = 0;

      function skip(){ while (i<s.length && /\s/.test(s[i])) i++; }
      function peek() { return s[i]; }
      function readIdent(){
        let start=i;
        while(i<s.length && /[A-Za-z_\.]/.test(s[i])) i++;
        return s.slice(start,i);
      }
      function readNumber(){
        let start=i;
        while(i<s.length && /[0-9\.\-+E]/i.test(s[i])) i++;
        return {type:'Literal', kind:'number', value: s.slice(start,i)};
      }
      function readString(){
        const q = s[i++]; let out=''; while(i<s.length){
          const c = s[i++]; if (c===q) break; if (c==='\\' && s[i]===q){ out+=q; i++; } else out+=c;
        }
        return {type:'Literal', kind:'string', value: out};
      }
      function readRefOrBoolOrIdent(){
        const start=i;
        while(i<s.length && /[^,\)\(]/.test(s[i])) i++;
        const raw = s.slice(start,i).trim();
        if (/^(TRUE|FALSE)$/.test(raw.toUpperCase())) return {type:'Literal', kind:'boolean', value: raw.toUpperCase()};
        return {type:'Ref', value: raw};
      }
      function readArg(){
        skip();
        const c = peek();
        if (c === '"' || c === "'") return readString();
        if (/[0-9\+\-\.]/.test(c)) return readNumber();
        if (/[A-Za-z_]/.test(c)){
          const name = readIdent();
          skip();
          if (peek()==='('){
            i++; // (
            const args = [];
            while (true){
              skip();
              if (peek()===')'){ i++; break; }
              args.push(readArg());
              skip();
              if (peek()===','){ i++; continue; }
              if (peek()===')'){ i++; break; }
              // unexpected — consume safely
              if (i>=s.length) break;
            }
            return {type:'Call', name: name.toUpperCase(), args};
          } else {
            // could be Ref/Name
            // consume until comma/paren
            while(i<s.length && /[^,\)]/.test(s[i])) i++;
            const token = (name + s.slice(i - (s[i-1] ? 0:0), i)).trim(); // name only
            return {type:'Ref', value: token || name};
          }
        }
        // fallback: read until comma/close
        return readRefOrBoolOrIdent();
      }

      // top-level can be a Call or expression
      const node = readArg();
      return node;
    }

    // pretty print node back to excel-ish string
    function pp(node){
      if (!node) return '';
      if (node.type==='Literal'){
        if (node.kind==='string') return `"${node.value.replace(/"/g,'""')}"`;
        return String(node.value);
      }
      if (node.type==='Ref') return node.value;
      if (node.type==='Call') return `${node.name}(${node.args.map(pp).join(', ')})`;
      return '';
    }

    // classify span chip
    function chipFor(node){
      let label=''; let cls='chip';
      if (!node) return '';
      if (node.type==='Literal'){
        if (node.kind==='string') label='ข้อความ';
        else if (node.kind==='number') label='ตัวเลข';
        else if (node.kind==='boolean') label='ตรรกะ';
      } else if (node.type==='Ref'){
        label = /:|!|\$/.test(node.value) || /[A-Za-z]+\d/.test(node.value) ? 'ช่วง/อ้างอิง' : 'ชื่อ/นิพจน์';
      } else if (node.type==='Call'){
        label = `ฟังก์ชัน ${node.name}`;
      }
      return `<span class="chip">${label}</span>`;
    }

    function toText(node){
      // plain text for copy
      const div = document.createElement('div'); div.innerHTML = explainHTML(node, {mode: $('#explainMode').value, pitfalls: $('#showPitfalls').checked, alt: $('#showAlternatives').checked});
      return div.innerText;
    }

    // 3) Explain renderer
    function explainHTML(node, opts){
      opts = Object.assign({mode:'detailed', pitfalls:true, alt:true}, opts||{});
      if (!node) return `<div class="muted">ยังไม่มีสูตร</div>`;

      if (node.type==='Call'){
        const meta = FCAT[node.name] || {summary:'', args:[]};
        const args = node.args;
        const header = `
          <div class="head">
            <h3 style="margin:.2rem 0">${node.name}</h3>
            <span class="chip">${meta.summary || 'ฟังก์ชันที่ไม่อยู่ในแคตาล็อก'}</span>
            <span class="chip">คืนค่า: ${meta.returns || '—'}</span>
          </div>
        `;

        // arguments mapping
        let mapped = [];
        if (typeof meta.mapArgs === 'function'){
          mapped = meta.mapArgs(args.map(a=> pp(a)));
        } else {
          // fallback map in order
          mapped = (meta.args||[]).map((label, i)=> [label, pp(args[i])]);
          if (args.length > (meta.args||[]).length){
            for (let j=(meta.args||[]).length;j<args.length;j++) mapped.push([`อาร์กิวเมนต์ที่ ${j+1}`, pp(args[j])]);
          }
        }

        const list = mapped.map(([label, val], idx)=>{
          const rawNode = node.args[idx]; // may be undefined if extra mapping
          const nested = rawNode && rawNode.type==='Call';
          const short = `<li><b>${label}</b>: <span class="code">${val ?? '(เว้นว่าง)'}</span> ${chipFor(rawNode || {type:'Ref', value: val||''})}</li>`;
          if (!nested || opts.mode==='basic') return short;
          // nested → put details
          return `
            <li>
              <div><b>${label}</b>: <span class="code">${val ?? '(เว้นว่าง)'}</span> ${chipFor(rawNode)}</div>
              <details style="margin-top:6px">
                <summary>ดูการทำงานภายในของ <b>${rawNode.name}</b></summary>
                ${explainHTML(rawNode, opts)}
              </details>
            </li>
          `;
        }).join('');

        // Step-by-step narration (selective by function)
        function narrative(){
          const n = node.name;
          const P = (i)=> pp(args[i]||{type:'Ref', value:''});
          if (n==='SUMIFS'){
            return `
              <div class="box">
                <div class="kv"><b>ขั้นตอน:</b> 
                  <span>1) เลือก <span class="code">${P(0)}</span> เป็นช่วงผลรวม</span>
                </div>
                <div style="margin-top:6px">
                  ${args.slice(1).map((_,i)=> i%2===0
                    ? `<div>2.${Math.floor(i/2)+1}) กรองด้วยเงื่อนไข: <span class="code">${P(1+i)}</span> ในช่วง <span class="code">${P(1+i+1)}</span></div>`
                    : ''
                  ).join('')}
                  <div style="margin-top:6px">3) รวมค่าที่เหลืออยู่ทั้งหมด</div>
                </div>
              </div>
            `;
          }
          if (n==='XLOOKUP'){
            const mm = args[4] ? pp(args[4]) : '0 (Exact)';
            const sm = args[5] ? pp(args[5]) : '1 (First-to-last)';
            return `
              <div class="box">
                <div><b>ขั้นตอน:</b> ค้นหา <span class="code">${P(0)}</span> ใน <span class="code">${P(1)}</span> (match_mode=${mm}, search_mode=${sm}) แล้วคืนค่าที่ตำแหน่งเดียวกันจาก <span class="code">${P(2)}</span>.</div>
              </div>
            `;
          }
          if (n==='INDEX'){
            const r = P(1)||'1', c = P(2)||'1';
            return `<div class="box"><b>ขั้นตอน:</b> เลือกค่าใน <span class="code">${P(0)}</span> ที่ตำแหน่ง แถว <span class="code">${r}</span>, คอลัมน์ <span class="code">${c}</span></div>`;
          }
          if (n==='MATCH'){
            const mt = args[2] ? pp(args[2]) : '1 (ค่าเริ่มต้น: น้อยกว่า)';
            return `<div class="box"><b>ขั้นตอน:</b> หา <span class="code">${P(0)}</span> ใน <span class="code">${P(1)}</span> ด้วย match_type=${mt} แล้วคืน <i>ลำดับที่</i> (เริ่มนับ 1)</div>`;
          }
          if (n==='FILTER'){
            return `<div class="box"><b>ขั้นตอน:</b> กรองแถวของ <span class="code">${P(0)}</span> ให้เหลือเฉพาะที่ <span class="code">${P(1)}</span> เป็นจริง แล้วคืนผลแบบ Dynamic Array</div>`;
          }
          if (n==='IF'){
            return `<div class="box"><b>ขั้นตอน:</b> ตรวจ <span class="code">${P(0)}</span> หากจริง → <span class="code">${P(1)}</span> มิฉะนั้น → <span class="code">${P(2)||'""'}</span></div>`;
          }
          return '';
        }

        // Notes & Pitfalls
        function notesBlock(){
          const blocks = [];
          if (FCAT[node.name]?.notes?.length && opts.alt){
            blocks.push(`<div><b>ทริก/ทางเลือก:</b><ul>${FCAT[node.name].notes.map(n=>`<li>${n}</li>`).join('')}</ul></div>`);
          }
          if (FCAT[node.name]?.pitfalls?.length && opts.pitfalls){
            blocks.push(`<div><b class="danger">ข้อควรระวัง:</b><ul>${FCAT[node.name].pitfalls.map(n=>`<li>${n}</li>`).join('')}</ul></div>`);
          }
          return blocks.join('');
        }

        return `
          <div class="card" style="padding:12px">
            ${header}
            <div style="margin-top:6px"><b>สูตร:</b> <span class="code">=${pp(node)}</span></div>
            <div style="margin-top:8px">
              <b>อาร์กิวเมนต์:</b>
              <ul class="arglist">
                ${list}
              </ul>
            </div>
            ${opts.mode==='detailed' ? narrative() : ''}
            <div style="margin-top:8px">${notesBlock()}</div>
          </div>
        `;
      }

      if (node.type==='Literal' || node.type==='Ref'){
        return `
          <div class="card" style="padding:12px">
            <div class="head">
              <h3 style="margin:.2rem 0">นิพจน์</h3>
              ${chipFor(node)}
            </div>
            <div><b>ค่า/อ้างอิง:</b> <span class="code">${pp(node)}</span></div>
          </div>
        `;
      }

      return `<div class="muted">ไม่สามารถวิเคราะห์สูตรนี้ได้</div>`;
    }

    // Wire Explain UI
    const exInput = $('#explainInput');
    const exOut = $('#explainOut');
    function runExplain(){
      const raw = exInput.value;
      if (!raw.trim()){ exOut.innerHTML = `<div class="muted">วางสูตรแล้วกด "อธิบายสูตร"</div>`; return; }
      const node = parseFormula(raw);
      const html = explainHTML(node, { mode: $('#explainMode').value, pitfalls: $('#showPitfalls').checked, alt: $('#showAlternatives').checked });
      exOut.innerHTML = html;
      save('last_explain', raw);
    }
    $('#doExplain').onclick = runExplain;
    $('#copyExplain').onclick = ()=> copy( toText(parseFormula(exInput.value||'')) );
    on(exInput,'keydown',(e)=>{ if (e.ctrlKey && e.key==='Enter') runExplain() });

    // Restore last explained if any
    const last = load('last_explain','');
    if (last){ exInput.value = last; }

    // Confetti
    const conf = $('#confetti'); const ctx = conf.getContext('2d'); const parts = [];
    function onResize(){ conf.width = innerWidth; conf.height = innerHeight } addEventListener('resize', onResize); onResize();
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#fff' }
    function confettiBurst(){
      for (let i=0;i<80;i++){
        parts.push({ x: Math.random()*conf.width, y: -10, vx: (Math.random()-.5)*4, vy: Math.random()*3+2, w: Math.random()*6+4, h: Math.random()*10+6, c: Math.random()<.5? '--accent':'--accent-2', a: 1, r: Math.random()*Math.PI });
      }
    }
    function tick(){
      ctx.clearRect(0,0,conf.width, conf.height);
      for (const p of parts){
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.r+=0.1; p.a-=0.006;
        ctx.save(); ctx.globalAlpha = Math.max(p.a,0); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle = cssVar(p.c); ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
      }
      for (let i=parts.length-1;i>=0;i--) if (parts[i].a<=0 || parts[i].y>conf.height+20) parts.splice(i,1);
      requestAnimationFrame(tick);
    }
    tick();

    // Onboarding
    if (!load('seen_tip', false)){ toast('Tip: กด Ctrl + K เพื่อสั่งงานเร็ว ๆ'); save('seen_tip', true); }
    on(document,'keydown',(e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ setTimeout(()=> $('#cmdInput').focus(), 50) } });
  </script>
</body>
</html>

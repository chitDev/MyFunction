<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel Formula Coach ‚Äî Tutorial ‚Ä¢ Quiz ‚Ä¢ Practice ‚Ä¢ Datasets</title>
  <meta name="description" content="‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏π‡∏ï‡∏£ Excel ‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏ä‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡∏ù‡∏∂‡∏Å‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏¥‡∏ã ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />
  <meta name="color-scheme" content="light dark" />
  <style>
    /* -----------------------------
       Design Tokens
    ------------------------------*/
    :root {
      --bg: #0b0e14;
      --ui: #121826;
      --card: #0f1525;
      --text: #e5ecff;
      --muted: #9fb0d3;
      --accent: #58c4ff;
      --accent-2: #8aeb8a;
      --danger: #ff6b6b;
      --ok: #23d18b;
      --warn: #ffd166;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --radius: 14px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --container: 1180px;
    }
    :root.light {
      --bg: #f6f8fc;
      --ui: #ffffff;
      --card: #ffffff;
      --text: #0b0e14;
      --muted: #52607a;
      --accent: #0066ff;
      --accent-2: #0bb36e;
      --shadow: 0 12px 28px rgba(10, 14, 25, .08);
    }

    /* -----------------------------
       Base
    ------------------------------*/
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font: 16px/1.6 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial, "Helvetica Neue", Helvetica, sans-serif;
      background: radial-gradient(1200px 600px at 70% -20%, rgba(88,196,255,.2), transparent 60%),
                  radial-gradient(800px 500px at -10% 10%, rgba(138,235,138,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      letter-spacing: .2px;
    }
    a { color: var(--accent); text-decoration: none }
    a:hover { text-decoration: underline }
    button, input, select, textarea { font: inherit }

    .container { width: 100%; max-width: var(--container); margin: 0 auto; padding: 24px }

    /* -----------------------------
       Header / Topbar
    ------------------------------*/
    header {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(120%) blur(10px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--muted) 20%, transparent);
    }
    .topbar {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px; align-items: center;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .3px }
    .fx {
      width: 34px; height: 34px; display: grid; place-items: center;
      border-radius: 10px; background: linear-gradient(140deg, var(--accent), var(--accent-2));
      color: #001018; box-shadow: var(--shadow); font-weight: 900;
    }

    .searchbar { display: grid; grid-template-columns: 1fr auto; gap: 10px }
    .searchbar input[type="search"]{
      width: 100%; border: 1px solid color-mix(in oklab, var(--muted) 30%, transparent);
      background: var(--card); color: var(--text); padding: 12px 14px; border-radius: var(--radius); outline: none;
    }
    .searchbar input[type="search"]::placeholder { color: color-mix(in oklab, var(--muted) 65%, transparent) }
    .kbd { margin-left: 10px; border: 1px solid color-mix(in oklab, var(--muted) 40%, transparent); padding: 2px 8px; border-radius: 8px; font-size: .85rem; color: var(--muted) }

    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 14px; border-radius: 10px; border: 1px solid transparent;
      background: color-mix(in oklab, var(--card) 85%, #0000);
      color: var(--text); cursor: pointer;
      transition: .2s ease transform, .2s ease box-shadow, .2s ease background;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow) }
    .btn.ghost { background: transparent; border-color: color-mix(in oklab, var(--muted) 30%, transparent) }
    .btn.accent { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #001018; font-weight: 700 }
    .btn.danger { background: linear-gradient(135deg, #ff8a8a, #ff6b6b); color: #190000; }
    .btn.small { padding: 8px 12px; border-radius: 8px; }

    .badge { font-size: .85rem; color: var(--muted); display: inline-flex; align-items: center; gap: 8px }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ok) }

    /* -----------------------------
       Chips / Tabs
    ------------------------------*/
    .chips { display: flex; gap: 10px; overflow:auto; padding: 8px 0 2px 0; scrollbar-width: thin }
    .chip {
      flex: 0 0 auto; padding: 8px 12px; border-radius: 999px;
      border: 1px solid color-mix(in oklab, var(--muted) 35%, transparent);
      background: color-mix(in oklab, var(--card) 80%, #0000); color: var(--text);
      cursor: pointer; font-weight: 600; font-size: .92rem;
    }
    .chip.active { border-color: transparent; background: color-mix(in oklab, var(--accent) 25%, #0000) }

    .tabs { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap }
    .tab {
      padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 700;
      border: 1px solid color-mix(in oklab, var(--muted) 35%, transparent);
      background: color-mix(in oklab, var(--ui) 85%, transparent);
    }
    /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
.tab {
  color: var(--text);
  background: color-mix(in oklab, var(--card) 95%, var(--accent) 5%);
  font-weight: 600;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏° hover ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
.tab:hover {
  background: color-mix(in oklab, var(--accent) 20%, var(--card) 80%);
  color: #fff; /* ‡∏Ç‡∏≤‡∏ß‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
}
    .tab.active {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: #001018; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
  font-weight: 700;
  box-shadow: 0 0 10px var(--accent); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡∏™‡∏ß‡πà‡∏≤‡∏á */
}

    /* -----------------------------
       Cards / Panels / Grid
    ------------------------------*/
    .grid { margin-top: 18px; display: grid; gap: 16px; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ) }
    .card { background: var(--card); border: 1px solid color-mix(in oklab, var(--muted) 22%, transparent); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow) }
    .card h3 { margin: 4px 0 10px 0 }
    .card .meta { font-size: .9rem; color: var(--muted) }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 99px; font-size: .8rem; border:1px solid color-mix(in oklab, var(--muted) 35%, transparent); color: var(--muted) }

    .panel { margin-top: 16px; background: var(--card); border:1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow) }
    .panel h4, .panel h3 { margin: 6px 0 12px 0 }

    /* -----------------------------
       Forms (Responsive Grid)
    ------------------------------*/
    .form-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .fg-12 { grid-column: span 12 }
    .fg-6  { grid-column: span 6 }
    .fg-4  { grid-column: span 4 }
    .fg-3  { grid-column: span 3 }
    .fg-2  { grid-column: span 2 }

    .field { display:flex; flex-direction: column; gap:6px }
    .field input[type="text"],
    .field input[type="number"],
    .field input[type="search"],
    .field select,
    .field textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid color-mix(in oklab, var(--muted) 30%, transparent);
      background: var(--card); color: var(--text);
    }

    /* -----------------------------
       Table (Datasets)
    ------------------------------*/
    table { width: 100%; border-collapse: collapse; font-variant-numeric: tabular-nums }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px dashed color-mix(in oklab, var(--muted) 30%, transparent) }
    th { position: sticky; top: 0; background: color-mix(in oklab, var(--ui) 90%, transparent); z-index: 1 }

    /* -----------------------------
       Dialog / Modal
    ------------------------------*/
    dialog { border: none; padding: 0; border-radius: 16px; width: min(880px, 92vw); background: var(--card); color: var(--text); box-shadow: var(--shadow) }
    dialog::backdrop { background: rgba(0,0,0,.35) }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid color-mix(in oklab, var(--muted) 25%, transparent) }
    .modal-body { padding: 16px 18px 20px 18px; max-height: 70vh; overflow: auto }
    .close { border:none; background:transparent; color: var(--muted); cursor:pointer; font-size: 22px }

    /* -----------------------------
       Footer / Utils
    ------------------------------*/
    footer { text-align: center; color: var(--muted); padding: 30px 0 50px }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center }
    .right { margin-left: auto }
    .muted { color: var(--muted) }
    .sr-only { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background: color-mix(in oklab, var(--muted) 10%, transparent); padding: 2px 6px; border-radius: 8px }

    /* Explain styles */
    .ex { display: grid; gap: 10px }
    .ex .head { display:flex; gap:10px; align-items:center; flex-wrap: wrap }
    .ex .chip { padding: 3px 8px; border-radius: 999px; border:1px solid color-mix(in oklab, var(--muted) 35%, transparent); color: var(--muted); font-size: .8rem }
    .ex .ok { color: var(--ok) }
    .ex .warn { color: var(--warn) }
    .ex .danger { color: var(--danger) }
    .ex .arglist { margin: 6px 0 0 0; padding-left: 18px }
    .ex .arglist li { margin: 4px 0 }
    .ex details { background: color-mix(in oklab, var(--muted) 10%, transparent); padding: 8px 10px; border-radius: 10px; border:1px dashed color-mix(in oklab, var(--muted) 25%, transparent) }
    .ex .kv { display:flex; gap:6px; align-items:center; flex-wrap: wrap }
    .ex .kv b { min-width: 180px }
    .ex .box { background: color-mix(in oklab, var(--muted) 10%, transparent); border:1px solid color-mix(in oklab, var(--muted) 25%, transparent); border-radius: 10px; padding: 10px }

    /* -----------------------------
       Confetti
    ------------------------------*/
    canvas#confetti { position: fixed; inset: 0; pointer-events: none; z-index: 60 }

    /* -----------------------------
       Responsive
    ------------------------------*/
    @media (max-width: 980px){
      .topbar { grid-template-columns: 1fr; gap: 10px }
      .toolbar { justify-content: flex-start }
    }
    @media (max-width: 720px){
      .searchbar { grid-template-columns: 1fr }
      .kbd { display:none }
      .fg-6 { grid-column: span 12 }
      .fg-4 { grid-column: span 12 }
      .fg-3 { grid-column: span 12 }
      .fg-2 { grid-column: span 12 }
      .container { padding: 18px }
      .tab { flex: 1 1 auto; text-align: center }
      .ex .kv b { min-width: 120px }
    }
  </style>
</head>
<body>
  <canvas id="confetti" aria-hidden="true"></canvas>

  <!-- Header -->
  <header>
    <div class="container topbar" role="navigation" aria-label="‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠">
      <div class="brand" aria-label="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå">
        <div class="fx" aria-hidden="true">fx</div>
        <div>
          <div style="font-size:1.05rem; opacity:.85">Excel Formula Coach</div>
          <div class="badge"><span class="dot"></span> ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‚Ä¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏∏‡∏ì</div>
        </div>
      </div>

      <div class="searchbar">
        <label class="sr-only" for="q">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏π‡∏ï‡∏£</label>
        <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶ ‡πÄ‡∏ä‡πà‡∏ô XLOOKUP, SUMIFS, TEXTJOIN ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå / ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™" autocomplete="off" />
        <div class="kbd">Ctrl + K</div>
      </div>

      <div class="toolbar" role="group" aria-label="‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
        <button class="btn ghost" id="themeBtn" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏á/‡∏°‡∏∑‡∏î" aria-label="Theme">üåì</button>
        <button class="btn" id="exportBtn" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" aria-label="Export">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
        <label class="btn" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" aria-label="Import">
          ‚¨ÜÔ∏è ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
          <input id="importFile" type="file" accept="application/json" hidden />
        </label>
        <button class="btn danger" id="resetBtn" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" aria-label="Reset">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      </div>
    </div>

    <div class="container">
      <div class="chips" id="catChips" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"></div>
      <div class="tabs" role="tablist" aria-label="‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">
        <button class="tab" data-tab="tutorial" role="tab">Tutorial</button>
        <button class="tab" data-tab="quiz" role="tab">Quiz</button>
        <button class="tab" data-tab="practice" role="tab">Practice</button>
        <button class="tab" data-tab="playground" role="tab">Playground</button>
        <button class="tab" data-tab="datasets" role="tab">Datasets</button>
        <button class="tab" data-tab="explain" role="tab">Explain</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <!-- Tutorial -->
    <section id="tutorial">
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
          <span class="muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‚Üí ‡∏™‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£</span>
          <span class="right pill" id="resultCount">0 ‡∏™‡∏π‡∏ï‡∏£</span>
        </div>
        <div class="grid" id="formulaGrid" aria-live="polite"></div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" hidden>
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">‡∏Ñ‡∏ß‡∏¥‡∏ã 10 ‡∏Ç‡πâ‡∏≠</h2>
          <span class="muted">‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Ä¢ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ &ge; 80% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</span>
          <div class="right row">
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö:
              <select id="quizLevel">
                <option>‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Advanced</option>
              </select>
            </label>
            <button class="btn accent" id="startQuiz">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏¥‡∏ã</button>
          </div>
        </div>
        <div id="quizArea" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Practice -->
    <section id="practice" hidden>
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">Daily Drills</h2>
          <span class="muted">‡∏ù‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö Spaced Repetition ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô</span>
          <button class="btn right" id="practiceRefill">‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå</button>
        </div>
        <div id="practiceArea" class="grid"></div>
      </div>
    </section>

    <!-- Playground -->
    <section id="playground" hidden>
      <!-- Evaluator -->
      <div class="panel">
        <h2 style="margin-top:0">Formula Playground (Mini Evaluator)</h2>
        <p class="muted">‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (TEXT/MATH) ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß: <span class="code">SUM</span>, <span class="code">AVERAGE</span>, <span class="code">MIN</span>, <span class="code">MAX</span>, <span class="code">LEN</span>, <span class="code">LEFT</span>, <span class="code">RIGHT</span>, <span class="code">UPPER</span>, <span class="code">LOWER</span>, <span class="code">CONCAT</span></p>
        <div class="row">
          <input id="playInput" type="text" placeholder='‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏π‡∏ï‡∏£ ‡πÄ‡∏ä‡πà‡∏ô =TEXTJOIN("-",, "A","B","C") ‡∏´‡∏£‡∏∑‡∏≠ =SUM(10,20,30)' style="flex:1; padding:12px 14px; border-radius:12px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)">
          <button id="runPlay" class="btn accent">Run ‚ñ∂</button>
        </div>
        <div id="playResult" style="margin-top:12px; font-family: ui-monospace, monospace"></div>
      </div>

      <!-- INDEX Builder (Simplified & Responsive) -->
      <div class="panel" id="indexBuilderPanel">
        <h3 style="margin:0">INDEX Builder ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
        <p class="muted" style="margin:.2rem 0 1rem 0">‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î <b>‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å (MATCH)</b> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏î</p>

        <!-- Mode -->
        <div class="row" role="group" aria-label="‡πÇ‡∏´‡∏°‡∏î INDEX Builder">
          <label class="btn small ghost"><input type="radio" name="idxMode" id="idxModeBasic" checked> ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</label>
          <label class="btn small ghost"><input type="radio" name="idxMode" id="idxModeDynamic"> ‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å (MATCH)</label>
          <span class="right muted">Tip: ‡∏ï‡∏¥‡πä‡∏Å <span class="code">$</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á ‡πÄ‡∏ß‡∏•‡∏≤ Copy ‡∏™‡∏π‡∏ï‡∏£</span>
        </div>

        <!-- Common -->
        <div class="form-grid" style="margin-top:10px">
          <div class="field fg-6">
            <label for="idxRange"><b>‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Range)</b></label>
            <input id="idxRange" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô A2:D100 ‡∏´‡∏£‡∏∑‡∏≠ A:D">
          </div>
          <div class="field fg-3">
            <label for="idxSheet">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input id="idxSheet" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Sales 2024">
          </div>
          <div class="field fg-3">
            <label>&nbsp;</label>
            <label class="row" style="gap:8px"><input id="idxAbs" type="checkbox"> ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏ö‡∏ö $ ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</label>
          </div>
        </div>

        <!-- BASIC inputs -->
        <div id="idxBasic" class="form-grid" style="margin-top:6px">
          <div class="field fg-6">
            <label for="idxRow"><b>‡πÅ‡∏ñ‡∏ß (row_num)</b></label>
            <input id="idxRow" type="number" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2">
          </div>
          <div class="field fg-6">
            <label for="idxCol"><b>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (column_num)</b></label>
            <input id="idxCol" type="number" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4">
          </div>
        </div>

        <!-- DYNAMIC (MATCH) inputs -->
        <div id="idxDynamic" class="form-grid" style="display:none; margin-top:6px">
          <div class="field fg-6">
            <label for="idxLookupRow"><b>‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏î‡πâ‡∏ß‡∏¢ MATCH</b> ‚Äî ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <input id="idxLookupRow" type="text" placeholder='‡πÄ‡∏ä‡πà‡∏ô "East" ‡∏´‡∏£‡∏∑‡∏≠ E2'>
          </div>
          <div class="field fg-6">
            <label for="idxLookupRowRange">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß</label>
            <input id="idxLookupRowRange" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô A:A ‡∏´‡∏£‡∏∑‡∏≠ A2:A100">
          </div>
          <div class="field fg-6">
            <label for="idxLookupCol"><b>‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡πâ‡∏ß‡∏¢ MATCH</b> ‚Äî ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
            <input id="idxLookupCol" type="text" placeholder='‡πÄ‡∏ä‡πà‡∏ô "Sales" ‡∏´‡∏£‡∏∑‡∏≠ C1'>
          </div>
          <div class="field fg-6">
            <label for="idxLookupColRange">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</label>
            <input id="idxLookupColRange" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1:1 ‡∏´‡∏£‡∏∑‡∏≠ A1:D1">
          </div>
        </div>

        <!-- Actions -->
        <div class="row" style="margin-top:8px">
          <div class="row" style="gap:8px">
            <button class="btn accent" id="idxCopy">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
            <button class="btn" id="idxExample">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            <button class="btn ghost" id="idxReset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          </div>
          <span class="right muted">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå</span>
        </div>

        <!-- Output -->
        <div id="idxOutput" class="panel" style="margin-top:12px; word-break: break-all"></div>
      </div>
    </section>

    <!-- Datasets -->
    <section id="datasets" hidden>
      <div class="panel">
        <div class="row">
          <h2 style="margin:0">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á & ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV</h2>
          <div class="right row">
            <button class="btn" id="loadSample">‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            <label class="btn">
              ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV
              <input type="file" id="csvFile" accept=".csv,text/csv" hidden />
            </label>
            <button class="btn ghost" id="downloadCsv">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
          </div>
        </div>
        <div id="dataMeta" class="muted" style="margin-top:4px"></div>
        <div style="margin-top:12px; overflow:auto; max-height: 60vh">
          <table id="dataTable"></table>
        </div>
      </div>

      <div class="panel">
        <h4 style="margin-top:0">Practice Tasks (‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)</h4>
        <ol id="dataTasks" style="padding-left: 20px"></ol>
      </div>
    </section>

    <!-- Explain -->
    <section id="explain" hidden>
      <div class="panel">
        <h2 style="margin-top:0">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏π‡∏ï‡∏£ (Detailed Explain)</h2>
        <div class="form-grid">
          <div class="field fg-12">
            <label for="explainInput">‡∏ß‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£ Excel ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
            <textarea id="explainInput" rows="4" placeholder='‡πÄ‡∏ä‡πà‡∏ô =SUMIFS(C:C, A:A, "East", B:B, "Apple")'></textarea>
          </div>
          <div class="field fg-6">
            <label for="explainMode">‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
            <select id="explainMode">
              <option value="detailed">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Step-by-step)</option>
              <option value="basic">‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°)</option>
            </select>
          </div>
          <div class="field fg-6">
            <label>&nbsp;</label>
            <div class="row">
              <label class="row" style="gap:8px"><input type="checkbox" id="showPitfalls" checked> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á</label>
              <label class="row" style="gap:8px"><input type="checkbox" id="showAlternatives" checked> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏ó‡∏£‡∏¥‡∏Å</label>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn accent" id="doExplain">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏π‡∏ï‡∏£</button>
          <button class="btn ghost" id="copyExplain">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</button>
          <span class="muted">Tip: ‡∏Å‡∏î <span class="code">Ctrl + Enter</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
        </div>

        <div id="explainOut" class="panel ex" style="margin-top:14px"></div>
      </div>
    </section>
  </main>

  <footer>
    <div>¬© 2025 Excel Formula Coach ‚Ä¢ ‡∏ó‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• üß©</div>
    <div>‡∏Å‡∏î <span class="code">?</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î ‚Ä¢ <span class="code">/</span> ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‚Ä¢ <span class="code">Ctrl + K</span> Command Palette</div>
  </footer>

  <!-- Dialogs -->
  <dialog id="formulaDialog" aria-label="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏ï‡∏£">
    <div class="modal-head">
      <div style="font-weight:800" id="fTitle">Formula</div>
      <button class="close" data-close>‚úñ</button>
    </div>
    <div class="modal-body" id="fBody"></div>
  </dialog>

  <dialog id="cmdDialog" aria-label="Command Palette">
    <div class="modal-head">
      <div style="font-weight:800">Command Palette</div>
      <button class="close" data-close>‚úñ</button>
    </div>
    <div class="modal-body">
      <input id="cmdInput" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‚Ä¶ (‡πÄ‡∏ä‡πà‡∏ô go quiz, toggle dark, export)" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)">
      <ul id="cmdList" style="list-style:none; margin:10px 0 0 0; padding:0; max-height: 50vh; overflow:auto"></ul>
    </div>
  </dialog>

  <dialog id="helpDialog" aria-label="‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ">
    <div class="modal-head">
      <div style="font-weight:800">‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î</div>
      <button class="close" data-close>‚úñ</button>
    </div>
    <div class="modal-body">
      <ul>
        <li><span class="code">/</span> ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</li>
        <li><span class="code">Ctrl + K</span> ‡πÄ‡∏õ‡∏¥‡∏î Command Palette</li>
        <li><span class="code">g t</span> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Tutorial ‚Ä¢ <span class="code">g q</span> ‡∏´‡∏ô‡πâ‡∏≤ Quiz ‚Ä¢ <span class="code">g p</span> Practice ‚Ä¢ <span class="code">g d</span> Datasets ‚Ä¢ <span class="code">g e</span> Explain</li>
        <li><span class="code">?</span> ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</li>
        <li><span class="code">Ctrl + Enter</span> ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏π‡∏ï‡∏£</li>
      </ul>
    </div>
  </dialog>

  <script>
    // Helpers
    const $ = (sel, el = document) => el.querySelector(sel);
    const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
    const h = (tag, props = {}, ...children) => {
      const el = Object.assign(document.createElement(tag), props);
      for (const c of children) el.append(c?.nodeType ? c : document.createTextNode(c));
      return el;
    };
    const on = (el, evt, fn) => el.addEventListener(evt, fn);
    const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}};
    const LSK = (k) => `efc_${k}`;
    const save = (k,v)=> localStorage.setItem(LSK(k), JSON.stringify(v));
    const load = (k, d=null)=> { try { const v=localStorage.getItem(LSK(k)); return v?JSON.parse(v):d } catch { return d } };
    const copy = async (txt)=> { try{ await navigator.clipboard.writeText(txt); toast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ") }catch{ alert(txt) } };
    const toast = (msg)=> {
      const t = h('div', {textContent: msg, style: `
        position: fixed; left: 50%; transform: translateX(-50%);
        bottom: 22px; background: var(--ui); color: var(--text);
        border: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
        padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow); z-index: 80;
      `});
      document.body.append(t); setTimeout(()=> t.remove(), 1800);
    };

    // Theme
    const themeBtn = $('#themeBtn');
    const applyTheme = () => {
      const theme = load('theme','dark');
      document.documentElement.classList.toggle('light', theme==='light');
      themeBtn.textContent = theme==='light' ? 'üåû' : 'üåì';
    };
    on(themeBtn,'click', ()=>{
      const next = (load('theme','dark')==='dark') ? 'light' : 'dark';
      save('theme', next); applyTheme();
    });
    applyTheme();

    // Data: Formulas Catalog
    const FORMULAS = [
      { id:'XLOOKUP', name:'XLOOKUP', cat:'Lookup', level:'Intermediate',
        desc:'‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå/‡πÅ‡∏ñ‡∏ß‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå/‡πÅ‡∏ñ‡∏ß',
        examples:['=XLOOKUP(A2, SKU!A:A, SKU!D:D, "N/A")','=XLOOKUP(E2, A:A, B:B,, -1)'],
        tips:['‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà VLOOKUP/HLOOKUP ‡πÑ‡∏î‡πâ', '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö'] },
      { id:'VLOOKUP', name:'VLOOKUP', cat:'Lookup', level:'Beginner',
        desc:'‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á',
        examples:['=VLOOKUP(A2, A:D, 4, FALSE)'],
        tips:['‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤‡∏Ç‡∏≠‡∏á lookup-key', '‡πÉ‡∏ä‡πâ FALSE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥'] },
      { id:'INDEX_MATCH', name:'INDEX + MATCH', cat:'Lookup', level:'Intermediate',
        desc:'‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢ MATCH ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢ INDEX (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)',
        examples:['=INDEX(D:D, MATCH(A2, A:A, 0))'],
        tips:['‡πÄ‡∏î‡∏¥‡∏ô‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞', '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå'] },
      { id:'SUMIF', name:'SUMIF', cat:'Math', level:'Beginner',
        desc:'‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', examples:['=SUMIF(A:A, ">100", B:B)'], tips:['‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏ä‡πâ SUMIFS'] },
      { id:'SUMIFS', name:'SUMIFS', cat:'Math', level:'Intermediate',
        desc:'‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', examples:['=SUMIFS(C:C, A:A, "East", B:B, "Apple")'], tips:['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡πå‡∏Å‡∏¥‡∏ß‡πÄ‡∏°‡∏ô‡∏ï‡πå: ‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°, ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç1, ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç1, ...'] },
      { id:'COUNTIFS', name:'COUNTIFS', cat:'Stat', level:'Beginner',
        desc:'‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', examples:['=COUNTIFS(A:A, "East", B:B, "Apple")'], tips:['‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ SUMIFS ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö'] },
      { id:'IF', name:'IF', cat:'Logical', level:'Beginner',
        desc:'‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ A ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡πá‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤ B', examples:['=IF(A2>=60, "‡∏ú‡πà‡∏≤‡∏ô", "‡∏ï‡∏Å")'], tips:['‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö AND/OR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ã‡πâ‡∏≠‡∏ô'] },
      { id:'AND_OR', name:'AND / OR', cat:'Logical', level:'Intermediate',
        desc:'‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (AND ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, OR ‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á)', examples:['=AND(A2>0, B2<100)','=OR(C2="Yes", D2="Y")'], tips:['‡πÉ‡∏ä‡πâ‡∏´‡πà‡∏≠‡∏Å‡∏±‡∏ö IF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏Å‡πÅ‡∏Ç‡∏ô‡∏á'] },
      { id:'TEXTJOIN', name:'TEXTJOIN', cat:'Text', level:'Intermediate',
        desc:'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô', examples:['=TEXTJOIN("-", TRUE, A2:C2)'], tips:['‡∏ï‡∏±‡πâ‡∏á ignore_empty=TRUE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á'] },
      { id:'LEFT_RIGHT_LEN', name:'LEFT / RIGHT / LEN', cat:'Text', level:'Beginner',
        desc:'‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß', examples:['=LEFT(A2, 3)','=RIGHT(A2, 4)','=LEN(A2)'], tips:['‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö FIND/MID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏¢‡πà‡∏≠‡∏¢'] },
      { id:'DATE_TIME', name:'TODAY / EOMONTH', cat:'Date', level:'Intermediate',
        desc:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô, ‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', examples:['=TODAY()','=EOMONTH(TODAY(), -1)'], tips:['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ß‡∏±‡∏ô ‚Äî ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£'] },
      { id:'FILTER', name:'FILTER', cat:'Array', level:'Advanced',
        desc:'‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö dynamic array', examples:['=FILTER(A2:D100, (A2:A100="East")*(B2:B100="Apple"))'], tips:['‡πÉ‡∏ä‡πâ * ‡πÅ‡∏ó‡∏ô AND ‡πÅ‡∏•‡∏∞ + ‡πÅ‡∏ó‡∏ô OR ‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô'] },
      { id:'UNIQUE_SORT', name:'UNIQUE / SORT', cat:'Array', level:'Intermediate',
        desc:'‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', examples:['=SORT(UNIQUE(A2:A100))'], tips:['‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö FILTER ‡πÑ‡∏î‡πâ‡∏î‡∏µ'] },
      { id:'LET', name:'LET', cat:'Other', level:'Advanced',
        desc:'‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏ã‡πâ‡∏≥‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', examples:['=LET(t, SUMIFS(C:C, A:A, "East"), t * 1.07)'], tips:['‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô'] },
      { id:'LAMBDA', name:'LAMBDA', cat:'Other', level:'Advanced',
        desc:'‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï', examples:['=LAMBDA(x, x^2)(5)'], tips:['‡πÉ‡∏ä‡πâ Name Manager ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥'] },
    ];
    const CATS = ['‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','Lookup','Math','Stat','Logical','Text','Date','Array','Other'];

    // Build Category Chips
    const catChips = $('#catChips'); let currentCat = load('cat','‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
    const renderChips = () => {
      catChips.innerHTML = '';
      CATS.forEach(cat=>{
        const b = h('button',{className:'chip'+(currentCat===cat?' active':''), textContent: cat});
        on(b,'click',()=>{ currentCat=cat; save('cat',cat); renderChips(); renderGrid() });
        catChips.append(b);
      });
    };
    renderChips();

    // Search + Grid (Tutorial)
    const q = $('#q'), grid = $('#formulaGrid'), resultCount = $('#resultCount');
    const match = (s, q) => s.toLowerCase().includes(q.trim().toLowerCase());
    const formulaCard = (f) => {
      const el = h('div',{className:'card'});
      el.append(
        h('div',{className:'row'},
          h('h3', {textContent: f.name, style:'margin:0'}),
          h('span', {className:'pill'}, f.cat),
          h('span', {className:'pill'}, f.level)
        ),
        h('div',{className:'muted'}, f.desc),
        h('div',{style:'margin-top:10px; display:flex; gap:8px; flex-wrap: wrap'},
          ...f.examples.slice(0,2).map(ex => {
            const b = h('button',{className:'btn ghost'}, '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ', h('span',{className:'code',textContent:ex}));
            on(b,'click',()=>copy(ex));
            return b;
          }),
          h('button',{className:'btn right', title:'‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'},'‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚ñ∂')
        )
      );
      el.querySelector('.right')?.addEventListener('click',()=> openFormulaDialog(f));
      return el;
    };
    const renderGrid = () => {
      const term = q.value.trim();
      let list = FORMULAS.filter(f=> currentCat==='‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' || f.cat===currentCat);
      if (term) list = list.filter(f=> match(f.name, term) || match(f.desc, term) || f.examples.some(e=>match(e,term)) );
      resultCount.textContent = `${list.length} ‡∏™‡∏π‡∏ï‡∏£`;
      grid.innerHTML = ''; for (const f of list) grid.append(formulaCard(f));
    };
    on(q,'input', debounce(renderGrid, 150));
    on(document,'keydown', (e)=>{ if (e.key === '/') { e.preventDefault(); q.focus() } });
    const openFormulaDialog = (f) => {
      $('#fTitle').textContent = f.name + ' ¬∑ ' + f.cat + ' ¬∑ ' + f.level;
      const body = $('#fBody'); body.innerHTML = '';
      body.append(h('p',{}, f.desc), h('h4',{}, '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á'), h('ul',{}, ...f.examples.map(x=>h('li',{}, h('span',{className:'code',textContent:x})))));
      if (f.tips?.length){ body.append(h('h4',{}, '‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö'), h('ul',{}, ...f.tips.map(t=>h('li',{},t)))); }
      $('#formulaDialog').showModal();
    };
    $$('#formulaDialog [data-close]').forEach(b=> on(b,'click', ()=> $('#formulaDialog').close() ));
    renderGrid();

    // Tabs
    const tabs = $$('.tab'); let currentTab = load('tab','tutorial');
    const showTab = (id) => {
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===id));
      $$('main > section').forEach(s=> s.hidden = s.id !== id);
      currentTab = id; save('tab', id);
    };
    tabs.forEach(t=> on(t,'click', ()=> showTab(t.dataset.tab)));
    showTab(currentTab);

    // Export / Import / Reset
    $('#exportBtn').onclick = () => {
      const data = {};
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i); if (k.startsWith('efc_')) data[k]=localStorage.getItem(k);
      }
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = h('a',{href: URL.createObjectURL(blob), download: 'efc_backup.json'}); a.click();
      toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå efc_backup.json ‡πÅ‡∏•‡πâ‡∏ß');
    };
    $('#importFile').onchange = async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const txt = await f.text();
      try {
        const data = JSON.parse(txt);
        Object.entries(data).forEach(([k,v])=> localStorage.setItem(k, v));
        toast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ'); location.reload();
      } catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
    };
    $('#resetBtn').onclick = ()=>{
      if (confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Excel Formula Coach ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ?')) {
        Object.keys(localStorage).filter(k=>k.startsWith('efc_')).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }
    };

    // Command Palette
    const cmdDialog = $('#cmdDialog'), cmdInput = $('#cmdInput'), cmdList = $('#cmdList');
    const COMMANDS = [
      {label:'Go: Tutorial', run:()=>showTab('tutorial')},
      {label:'Go: Quiz', run:()=>showTab('quiz')},
      {label:'Go: Practice', run:()=>showTab('practice')},
      {label:'Go: Playground', run:()=>showTab('playground')},
      {label:'Go: Datasets', run:()=>showTab('datasets')},
      {label:'Go: Explain', run:()=>showTab('explain')},
      {label:'Start: 10-question quiz', run:()=>{ showTab('quiz'); startQuiz() }},
      {label:'Toggle: Dark/Light', run:()=> $('#themeBtn').click() },
      {label:'Export data', run:()=> $('#exportBtn').click() },
      {label:'Import data', run:()=> $('#importFile').click() },
      {label:'Reset data', run:()=> $('#resetBtn').click() },
      {label:'Help / Shortcuts', run:()=> $('#helpDialog').showModal() },
      {label:'Open: INDEX Builder (Playground)', run:()=>{ showTab('playground'); document.getElementById('indexBuilderPanel')?.scrollIntoView({behavior:'smooth', block:'start'}) }},
    ];
    const openCmd = ()=>{ cmdDialog.showModal(); cmdInput.value=''; renderCmd('') };
    const closeCmd = ()=> cmdDialog.close();
    const renderCmd = (q)=> {
      cmdList.innerHTML = '';
      const items = COMMANDS.filter(c=> c.label.toLowerCase().includes(q.toLowerCase()));
      items.forEach(c=>{
        const li = h('li',{style:'padding:10px 6px; border-bottom:1px dashed color-mix(in oklab, var(--muted) 25%, transparent); cursor:pointer'}, c.label);
        on(li,'click', ()=>{ c.run(); closeCmd() });
        cmdList.append(li);
      });
      if (!items.length) cmdList.append(h('li',{className:'muted', style:'padding:10px 6px'}, '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á'));
    };
    on(cmdInput,'input', ()=> renderCmd(cmdInput.value));
    $$('#cmdDialog [data-close]').forEach(b=> on(b,'click', closeCmd));
    on(document,'keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd() }
      if (e.key === '?'){ e.preventDefault(); $('#helpDialog').showModal() }
      if (e.key === 'Escape'){ [cmdDialog,$('#helpDialog'),$('#formulaDialog')].forEach(d=> d.open && d.close()) }
      if (e.key==='g'){
        let seq='g '; const handler=(ev)=>{
          seq += ev.key; if (seq.endsWith('g t')) showTab('tutorial');
          if (seq.endsWith('g q')) showTab('quiz');
          if (seq.endsWith('g p')) showTab('practice');
          if (seq.endsWith('g d')) showTab('datasets');
          if (seq.endsWith('g e')) showTab('explain');
          document.removeEventListener('keydown', handler);
        };
        document.addEventListener('keydown', handler, {once:true});
      }
    });

    // Quiz
    const quizArea = $('#quizArea'); const quizLevel = $('#quizLevel');
    $('#startQuiz').onclick = ()=> startQuiz();
    const pick = (arr,n)=> arr.sort(()=>Math.random()-0.5).slice(0,n);
    const QUESTIONS_POOL = [
      ()=>({type:'mc', q:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà Region = "East" ‡πÅ‡∏•‡∏∞ Product = "Apple" ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏î?', choices:['SUMIF','SUMIFS','FILTER','XLOOKUP'], answer: 'SUMIFS'}),
      ()=>({type:'mc', q:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ SKU ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™ ‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏î‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏∏‡∏î?', choices:['VLOOKUP','INDEX + MATCH','TEXTJOIN','COUNTIFS'], answer: 'INDEX + MATCH'}),
      ()=>({type:'fill', q:'‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: XLOOKUP(lookup_value, lookup_array, return_array, [if_not_found], [match_mode], [search_mode])', answerPattern:/^\s*XLOOKUP\s*\(\s*lookup_value\s*,\s*lookup_array\s*,\s*return_array/i}),
      ()=>({type:'read', q:'‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£: =TEXTJOIN("-", TRUE, A2:C2)', answer: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á A2:C2 ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ "-" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á'}),
      ()=>({type:'mc', q:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Region ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å A‚ÜíZ ‡πÉ‡∏ä‡πâ‡∏≠‡∏∞‡πÑ‡∏£?', choices:['UNIQUE','SORT','SORT(UNIQUE(...))','FILTER'], answer: 'SORT(UNIQUE(...))'}),
      ()=>({type:'mc', q:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ > 1000 ‡πÅ‡∏•‡∏∞ Region = "West" ‡πÅ‡∏ö‡∏ö Dynamic Array', choices:['FILTER','SUMIFS','COUNTIF','IF'], answer: 'FILTER'}),
      ()=>({type:'mc', q:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ?', choices:['EOMONTH(TODAY(), -1)','TODAY()-30','DATE(YEAR(TODAY()),MONTH(TODAY()),0)','TEXTJOIN'], answer: 'EOMONTH(TODAY(), -1)'}),
      ()=>({type:'read', q:'‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£: =IF(AND(A2>0, B2<100),"OK","CHECK")', answer: '‡∏ñ‡πâ‡∏≤ A2 > 0 ‡πÅ‡∏•‡∏∞ B2 < 100 ‡πÉ‡∏´‡πâ "OK" ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ "CHECK"'})
    ];
    function buildQuizQuestions(level){ return pick(QUESTIONS_POOL.map(f=>f()), 10); }
    function startQuiz(){ const qs = buildQuizQuestions(quizLevel.value); save('last_quiz', qs); renderQuiz(qs); }
    function renderQuiz(qs){
      quizArea.innerHTML = ''; let answers = [];
      qs.forEach((it, idx)=>{
        const item = h('div',{className:'card'});
        item.append(h('div',{className:'pill'}, `‡∏Ç‡πâ‡∏≠ ${idx+1}/${qs.length}`));
        item.append(h('h3',{}, it.q));
        if (it.type==='mc'){
          const grp = `q${idx}`;
          it.choices.forEach(ch=>{
            const label = h('label',{style:'display:flex; gap:10px; align-items:center; padding:6px 0; cursor:pointer'});
            const r = h('input',{type:'radio', name:grp, value:ch});
            label.append(r, h('span',{}, ch)); item.append(label);
          });
        } else if (it.type==='fill'){
          const inp = h('input',{type:'text', placeholder:'‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', style:'width:100%; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); item.append(inp);
        } else if (it.type==='read'){
          const inp = h('textarea',{rows:2, placeholder:'‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ', style:'width:100%; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); item.append(inp);
        }
        quizArea.append(item);
      });
      const submit = h('button',{className:'btn accent', style:'margin-top:12px'}, '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');
      on(submit,'click', ()=>{
        let score=0;
        $$('#quizArea .card').forEach((card,i)=>{
          const it = qs[i]; let ok=false;
          if (it.type==='mc'){
            const v = card.querySelector('input[type=radio]:checked')?.value; ok = v===it.answer;
          } else if (it.type==='fill'){
            const v = card.querySelector('input')?.value || ''; ok = it.answerPattern.test(v);
          } else if (it.type==='read'){
            const v = (card.querySelector('textarea')?.value || '').toLowerCase(); ok = ['‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°','‡∏Å‡∏£‡∏≠‡∏á','‡∏£‡∏ß‡∏°','‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤','‡∏ñ‡πâ‡∏≤'].some(k=> v.includes(k));
          }
          if (ok) score++; card.style.outline = `2px solid ${ok? 'var(--ok)':'var(--danger)'}`;
        });
        const pct = Math.round(score/qs.length*100); toast(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ${pct}%`);
        if (pct>=80){ confettiBurst(); awardBadge() }
        const hist = load('quiz_hist',[]); hist.push({ts:Date.now(), pct}); save('quiz_hist', hist);
      });
      quizArea.append(submit);
    }
    function awardBadge(){ const key='badge_80'; if (!load(key,false)){ save(key,true); toast('üèÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Badge: Quiz 80%'); } }

    // Practice
    const practiceArea = $('#practiceArea'), practiceRefill = $('#practiceRefill');
    function genPracticeCards(){
      const picks = pick(FORMULAS, 6); practiceArea.innerHTML = '';
      picks.forEach(f=>{
        const c = h('div',{className:'card'});
        c.append(h('div',{className:'row'}, h('h3',{}, f.name), h('span',{className:'pill'}, f.cat), h('span',{className:'pill'}, f.level)));
        c.append(h('div',{className:'muted'}, f.desc));
        const ans = h('input',{type:'text', placeholder:'‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏π‡∏ï‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ï‡∏£‡∏ß‡∏à', style:'width:100%; margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); 
        const row = h('div',{className:'row', style:'margin-top:8px'});
        const check = h('button',{className:'btn accent'}, '‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');
        const give = h('button',{className:'btn'}, '‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
        const stat = h('span',{className:'right muted'});
        row.append(check, give, stat); c.append(ans, row);
        on(check,'click', ()=>{
          const v = ans.value.toUpperCase(); const ok = v.includes(f.name.split(' ')[0]);
          c.style.outline = `2px solid ${ok? 'var(--ok)':'var(--danger)'}`; stat.textContent = ok? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‚úÖ' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡∏π‡∏ô‡∏∞';
          const k = 'practice_'+f.id; const curr = load(k,{ok:0, fail:0}); ok ? curr.ok++ : curr.fail++; save(k,curr);
        });
        on(give,'click', ()=>{ alert('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\n' + f.examples.join('\n')); });
        practiceArea.append(c);
      });
    }
    practiceRefill.onclick = genPracticeCards; genPracticeCards();

    // Playground (Mini Evaluator)
    function evalSimple(expr){
      const s = expr.trim().replace(/^=/,'').toUpperCase();
      const fnMatch = /^([A-Z]+)\s*\((.*)\)$/.exec(s);
      if (!fnMatch) throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ =SUM(...), =TEXTJOIN(...), ...');
      const fn = fnMatch[1]; const args = splitArgs(fnMatch[2]).map(x => parseArg(x));
      switch(fn){
        case 'SUM': return args.reduce((a,b)=>a+toNum(b),0);
        case 'AVERAGE': return args.reduce((a,b)=>a+toNum(b),0)/args.length;
        case 'MIN': return Math.min(...args.map(toNum));
        case 'MAX': return Math.max(...args.map(toNum));
        case 'LEN': return (args[0]+'').length;
        case 'LEFT': return (args[0]+'').slice(0, toNum(args[1]||0));
        case 'RIGHT': { const t=(args[0]+''); const n=toNum(args[1]||0); return t.slice(t.length-n) }
        case 'UPPER': return (args[0]+'').toUpperCase();
        case 'LOWER': return (args[0]+'').toLowerCase();
        case 'CONCAT': return args.map(String).join('');
        case 'TEXTJOIN': {
          const [delim, ignoreEmpty, ...rest] = args;
          const joiner = String(delim ?? '');
          const items = rest.flatMap(x => Array.isArray(x)? x : [x]).map(String);
          const out = (ignoreEmpty ? items.filter(v=>v!=='') : items).join(joiner);
          return out;
        }
        default: throw new Error('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Mini Evaluator');
      }
    }
    function splitArgs(s){
      const out=[], buf=[]; let depth=0, inStr=false, quote='"';
      for (let i=0;i<s.length;i++){
        const c = s[i], p = s[i-1];
        if ((c=='"'||c=="'") && p!=='\\'){ if (inStr && c===quote) inStr=false; else if(!inStr){ inStr=true; quote=c } }
        if (!inStr && c==='(') depth++;
        if (!inStr && c===')' && depth>0) depth--;
        if (!inStr && depth===0 && c===','){ out.push(buf.join('').trim()); buf.length=0; continue; }
        buf.push(c);
      }
      if (buf.length) out.push(buf.join('').trim());
      return out;
    }
    function parseArg(x){
      if (/^".*"$/.test(x) || /^'.*'$/.test(x)) return x.slice(1,-1);
      if (/^\d+(\.\d+)?$/.test(x)) return Number(x);
      if (/^{.*}$/.test(x)) return x.slice(1,-1).split(';');
      return x;
    }
    const toNum = (v)=> typeof v==='number' ? v : Number(String(v).replace(/[^0-9\.\-]/g,''))||0;
    on($('#runPlay'),'click', ()=>{
      const inp = $('#playInput').value;
      try { const res = evalSimple(inp);
        $('#playResult').innerHTML = `<div class="card"><b>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</b> <span class="code">${String(res)}</span></div>`;
      } catch(e){
        $('#playResult').innerHTML = `<div class="card" style="border-color: var(--danger)"><b>‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b> ${e.message}</div>`;
      }
    });

    // INDEX Builder (Simplified)
    (function(){
      const el = {
        range: $('#idxRange'), sheet: $('#idxSheet'), abs: $('#idxAbs'),
        row: $('#idxRow'), col: $('#idxCol'),
        modeBasic: $('#idxModeBasic'), modeDyn: $('#idxModeDynamic'),
        basicBox: $('#idxBasic'), dynBox: $('#idxDynamic'),
        lookupRow: $('#idxLookupRow'), lookupRowRange: $('#idxLookupRowRange'),
        lookupCol: $('#idxLookupCol'), lookupColRange: $('#idxLookupColRange'),
        out: $('#idxOutput'), copy: $('#idxCopy'), ex: $('#idxExample'), reset: $('#idxReset')
      };
      const escHtml = (s) => String(s).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
      const needsQuote = (v) => {
        const s = (v||'').trim();
        if (!s) return false;
        if (/^".*"$/.test(s) || /^'.*'$/.test(s)) return false;
        if (/^-?\d+(\.\d+)?$/.test(s)) return false;
        if (/^[A-Za-z]+\d+(:[A-Za-z]+\d+)?$/.test(s)) return false; // A1 or A1:B2
        if (/^[A-Za-z]+:[A-Za-z]+$/.test(s) || /^\d+:\d+$/.test(s)) return false; // A:D or 1:1
        return true;
      };
      const quoteVal = (v) => needsQuote(v) ? `"${String(v).replace(/"/g,'""')}"` : v;
      const escapeSheet = (name) => `'${String(name).replace(/'/g, "''")}'`;

      const absolutizeToken = (t) => {
        t = t.trim();
        if (/^[A-Za-z]+\d+$/.test(t)) { const [,c,r] = t.match(/^([A-Za-z]+)(\d+)$/); return `$${c.toUpperCase()}$${r}`; }
        if (/^[A-Za-z]+$/.test(t)) return `$${t.toUpperCase()}`; // A:D or A:A side
        if (/^\d+$/.test(t)) return `$${t}`; // 1:1
        return t;
      };
      const absolutizeRange = (rng) => {
        const parts = rng.split(':').map(s=>s.trim());
        if (parts.length === 1) return absolutizeToken(parts[0]);
        return absolutizeToken(parts[0]) + ':' + absolutizeToken(parts[1]);
      };

      function showMode(){
        const dyn = el.modeDyn.checked;
        el.basicBox.style.display = dyn ? 'none' : '';
        el.dynBox.style.display = dyn ? '' : 'none';
      }

      function build(){
        let range = (el.range.value || '').trim();
        const sheet = (el.sheet.value || '').trim();
        const isAbs = !!el.abs.checked;
        const dyn = el.modeDyn.checked;

        if (!range){
          el.out.innerHTML = `<div class="muted">‡∏û‡∏¥‡∏°‡∏û‡πå <span class="code">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span> ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô <span class="code">A2:D100</span> ‡∏´‡∏£‡∏∑‡∏≠ <span class="code">A:D</span></div>`;
          return '';
        }
        if (isAbs){ range = range.split(',').map(r => absolutizeRange(r.trim())).join(','); }
        if (sheet) range = `${escapeSheet(sheet)}!${range}`;

        let rowArg = (el.row.value || '').trim();
        let colArg = (el.col.value || '').trim();

        if (dyn){
          // row by MATCH
          const rv = quoteVal((el.lookupRow.value || '').trim());
          let rr = (el.lookupRowRange.value || '').trim() || 'A:A';
          if (isAbs) rr = absolutizeRange(rr);
          if (sheet) rr = `${escapeSheet(sheet)}!${rr}`;
          rowArg = `MATCH(${rv}, ${rr}, 0)`;

          // col by MATCH
          const cv = quoteVal((el.lookupCol.value || '').trim());
          let cr = (el.lookupColRange.value || '').trim() || '1:1';
          if (isAbs) cr = absolutizeRange(cr);
          if (sheet) cr = `${escapeSheet(sheet)}!${cr}`;
          colArg = `MATCH(${cv}, ${cr}, 0)`;
        } else {
          if (!rowArg) rowArg = '1';
          if (!colArg) colArg = '1';
        }

        const formula = colArg ? `=INDEX(${range}, ${rowArg}, ${colArg})` : `=INDEX(${range}, ${rowArg})`;
        el.out.innerHTML = `<b>‡∏™‡∏π‡∏ï‡∏£:</b> <span class="code">${escHtml(formula)}</span>`;
        return formula;
      }

      // Events
      [el.range, el.sheet, el.abs, el.row, el.col, el.lookupRow, el.lookupRowRange, el.lookupCol, el.lookupColRange]
        .forEach(i=> i && on(i,'input', build));
      [el.modeBasic, el.modeDyn].forEach(r => on(r,'change', ()=>{ showMode(); build(); }));

      on(el.copy,'click', ()=>{ const f = build(); if (f) copy(f); });
      on(el.ex,'click', ()=>{
        el.modeDyn.checked = true; showMode();
        el.sheet.value = 'Sales';
        el.range.value = 'A2:D100';
        el.abs.checked = true;
        el.row.value = ''; el.col.value = '';
        el.lookupRow.value = 'East'; el.lookupRowRange.value = 'A:A';
        el.lookupCol.value = 'Sales'; el.lookupColRange.value = '1:1';
        build(); toast('‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      });
      on(el.reset,'click', ()=>{
        ['range','sheet','row','col','lookupRow','lookupRowRange','lookupCol','lookupColRange'].forEach(k => el[k].value='');
        el.abs.checked = false; el.modeBasic.checked = true; showMode(); build();
      });

      // init
      showMode(); build();
    })();

    // Datasets
    const SAMPLE_CSV = `Region,Product,Qty,Price,Sales
East,Apple,4,3,12
East,Banana,3,2,6
West,Apple,5,3,15
North,Cherry,7,4,28
South,Apple,8,3,24
East,Cherry,2,4,8
West,Banana,10,2,20
North,Apple,6,3,18
South,Banana,9,2,18
East,Apple,12,3,36
West,Cherry,1,4,4
South,Apple,3,3,9
North,Banana,5,2,10
East,Cherry,11,4,44
West,Apple,2,3,6`;
    const dataTable = $('#dataTable'), dataMeta = $('#dataMeta'); const dataTasks = $('#dataTasks');
    $('#loadSample').onclick = ()=> loadCsv(SAMPLE_CSV);
    $('#downloadCsv').onclick = ()=>{ const blob = new Blob([SAMPLE_CSV], {type:'text/csv'}); const a = h('a',{href: URL.createObjectURL(blob), download:'sample_sales.csv'}); a.click(); };
    $('#csvFile').onchange = async (e)=>{ const f = e.target.files[0]; if (!f) return; const txt = await f.text(); loadCsv(txt); };
    function loadCsv(txt){
      const rows = txt.trim().split(/\r?\n/).map(r=> r.split(','));
      const [header, ...data] = rows;
      dataMeta.textContent = `‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${data.length.toLocaleString()} ‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${header.length}`;
      dataTable.innerHTML = '';
      const thead = h('thead',{}, h('tr',{}, ...header.map(hd=>h('th',{}, hd))));
      const tbody = h('tbody',{}, ...data.map(r=> h('tr',{}, ...r.map(c=> h('td',{}, c)))));
      dataTable.append(thead, tbody); buildDataTasks(header, data);
    }
    function buildDataTasks(header, data){
      dataTasks.innerHTML = '';
      const tasks = [
        {title:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠ Region', hint:'‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ SUMIFS ‡∏´‡∏£‡∏∑‡∏≠ SUMIF + ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', expect: /SUMIFS?\s*\(/i},
        {title:'‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Region ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á A‚ÜíZ', hint:'‡πÉ‡∏ä‡πâ UNIQUE ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö SORT', expect: /SORT\s*\(\s*UNIQUE\s*\(/i},
        {title:'‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà Product = "Apple"', hint:'‡∏•‡∏≠‡∏á FILTER ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', expect: /FILTER\s*\(/i},
        {title:'‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á Apple', hint:'AVERAGEIF/AVERAGEIFS ‡∏Å‡πá‡πÑ‡∏î‡πâ', expect: /(AVERAGEIFS?|AVERAGE)\s*\(/i}
      ];
      tasks.forEach((t,i)=>{
        const li = h('li',{}, h('div',{className:'row'}, h('b',{}, t.title), h('span',{className:'muted'}, ' ‚Ä¢ Hint: '+t.hint)));
        const inp = h('input',{type:'text', placeholder:'‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏ä‡πâ‚Ä¶', style:'width:100%; margin-top:6px; padding:10px 12px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--card); color: var(--text)'}); 
        const btn = h('button',{className:'btn', style:'margin-top:6px'}, '‡∏ï‡∏£‡∏ß‡∏à');
        const status = h('span',{className:'muted', style:'margin-left:10px'});
        btn.onclick = ()=>{ const ok = t.expect.test((inp.value||'').toUpperCase()); status.textContent = ok? '‚úÖ ‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏•‡∏≠‡∏á‡∏î‡∏π Hint'; if (ok) confettiBurst(); };
        li.append(inp, btn, status); dataTasks.append(li);
      });
    }

    // =========================================
    // Explain ‚Äî Deep, Step-by-step Explainer
    // =========================================
    // 1) Function catalog: arguments, defaults, notes, pitfalls
    const FCAT = {
      SUMIF: {
        summary: '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
        args: ['range','criteria','[sum_range]'],
        mapArgs: (args)=> {
          const [range, criteria, sum_range] = args;
          return [
            ['‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (range)', range],
            ['‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (criteria)', criteria],
            ['‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° (sum_range)', sum_range ?? '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‚Üí ‡πÉ‡∏ä‡πâ range ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)']
          ];
        },
        returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏•‡∏Ç)',
        notes:['‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ sum_range ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å range ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á'],
        pitfalls:['‡∏ï‡∏±‡∏ß‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î ‡πÄ‡∏ä‡πà‡∏ô '+'"'+'>=100'+'"' ]
      },
      SUMIFS: {
        summary: '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç',
        args: ['sum_range','criteria_range1','criteria1','...'],
        mapArgs: (args)=> {
          const list = [];
          if (args.length) list.push(['‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏° (sum_range)', args[0]]);
          for (let i=1;i<args.length;i+=2){
            list.push([`‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç${(i+1)/2} (criteria_range${(i+1)/2})`, args[i]]);
            list.push([`‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç${(i+1)/2} (criteria${(i+1)/2})`, args[i+1] ?? '(‡∏Ç‡∏≤‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)']);
          }
          return list;
        },
        returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏•‡∏Ç)',
        notes:['‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏π‡πà ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Üî ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç','‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö AND (‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)'],
        pitfalls:['‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô']
      },
      COUNTIFS: {
        summary:'‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç',
        args:['criteria_range1','criteria1','...'],
        mapArgs:(args)=>{
          const list=[];
          for (let i=0;i<args.length;i+=2){
            list.push([`‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç${(i/2)+1}`, args[i]]);
            list.push([`‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç${(i/2)+1}`, args[i+1] ?? '(‡∏Ç‡∏≤‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)']);
          }
          return list;
        },
        returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°)',
        notes:['‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö AND'],
        pitfalls:['‡∏ä‡πà‡∏ß‡∏á‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô']
      },
      XLOOKUP: {
        summary:'‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô',
        args:['lookup_value','lookup_array','return_array','[if_not_found]','[match_mode]','[search_mode]'],
        defaults:{ match_mode:0, search_mode:1 },
        mapArgs:(args)=>{
          const [lv, la, ra, inf, mm, sm] = args;
          return [
            ['‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (lookup_value)', lv],
            ['‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (lookup_array)', la],
            ['‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (return_array)', ra],
            ['‡∏Ñ‡πà‡∏≤‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö (if_not_found)', inf ?? '(‡∏ß‡πà‡∏≤‡∏á ‚Üí #N/A)'],
            ['‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (match_mode)', mm ?? '0 (Exact match)'],
            ['‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (search_mode)', sm ?? '1 (First-to-last)'],
          ];
        },
        returns:'‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå',
        notes:['‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà VLOOKUP/HLOOKUP ‡πÑ‡∏î‡πâ','‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (search_mode = -1) ‡πÅ‡∏•‡∏∞ wildcard (*, ?) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ match_mode = 2'],
        pitfalls:['‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á lookup_array ‡πÅ‡∏•‡∏∞ return_array ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏Å‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô']
      },
      VLOOKUP:{
        summary:'‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î',
        args:['lookup_value','table_array','col_index_num','[range_lookup]'],
        defaults:{ range_lookup:false },
        mapArgs:(a)=>{
          const [lv, ta, col, approx] = a;
          return [
            ['‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', lv],
            ['‡∏ï‡∏≤‡∏£‡∏≤‡∏á (table_array)', ta],
            ['‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (1=‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î)', col],
            ['‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (range_lookup)', approx ?? 'FALSE (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ FALSE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)']
          ];
        },
        returns:'‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå',
        notes:['‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á table_array'],
        pitfalls:['‡∏ñ‡πâ‡∏≤ range_lookup ‡πÄ‡∏õ‡πá‡∏ô TRUE/‡∏•‡∏∞‡πÑ‡∏ß‡πâ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á A‚ÜíZ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏ú‡∏•‡∏≠‡∏≤‡∏à‡∏ú‡∏¥‡∏î']
      },
      INDEX:{
        summary:'‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏ñ‡∏ß/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á',
        args:['array','row_num','[column_num]'],
        mapArgs:(a)=>{
          const [arr, r, c] = a;
          return [
            ['‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (array)', arr],
            ['‡πÅ‡∏ñ‡∏ß (row_num)', r ?? '1'],
            ['‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (column_num)', c ?? '1']
          ];
        },
        returns:'‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'
      },
      MATCH:{
        summary:'‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á',
        args:['lookup_value','lookup_array','[match_type]'],
        defaults:{ match_type:1 },
        mapArgs:(a)=>{
          const [lv, la, mt] = a;
          const t = (mt ?? '1') + ' (1=‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤, 0=‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß, -1=‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)';
          return [
            ['‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (lookup_value)', lv],
            ['‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (lookup_array)', la],
            ['‡∏ä‡∏ô‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (match_type)', mt ?? t]
          ];
        },
        returns:'‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏î‡∏±‡∏ä‡∏ô‡∏µ)'
      },
      FILTER:{
        summary:'‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Üí ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô Dynamic Array',
        args:['array','include','[if_empty]'],
        mapArgs:(a)=>{
          const [arr, inc, empty] = a;
          return [
            ['‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (array)', arr],
            ['‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏ß‡∏° (include)', inc],
            ['‡∏Ñ‡πà‡∏≤‡∏´‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏á (if_empty)', empty ?? '‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‚Üí #CALC!']
          ];
        },
        returns:'‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö Dynamic Array',
        notes:['‡πÉ‡∏ä‡πâ * ‡πÅ‡∏ó‡∏ô AND ‡πÅ‡∏•‡∏∞ + ‡πÅ‡∏ó‡∏ô OR ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç'],
        pitfalls:['‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á include ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏Å‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á']
      },
      UNIQUE:{
        summary:'‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á',
        args:['array','[by_col]','[exactly_once]'],
        mapArgs:(a)=>{
          const [arr, byCol, once] = a;
          return [
            ['‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', arr],
            ['‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (by_col)', byCol ?? 'FALSE'],
            ['‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (exactly_once)', once ?? 'FALSE']
          ];
        },
        returns:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥'
      },
      SORT:{
        summary:'‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        args:['array','[sort_index]','[sort_order]','[by_col]'],
        mapArgs:(a)=>{
          const [arr, idx, ord, byCol] = a;
          return [
            ['‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', arr],
            ['‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå/‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á (sort_index)', idx ?? '1'],
            ['‡∏•‡∏≥‡∏î‡∏±‡∏ö (sort_order)', ord ?? '1 (‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å)'],
            ['‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (by_col)', byCol ?? 'FALSE']
          ];
        },
        returns:'‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß'
      },
      TEXTJOIN:{
        summary:'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô',
        args:['delimiter','ignore_empty','text1','[text2]','...'],
        mapArgs:(a)=>{
          const [d, ign, ...rest] = a;
          return [
            ['‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô (delimiter)', d],
            ['‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (ignore_empty)', ign],
            ['‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°', rest.length? rest.join(', ') : '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏)']
          ];
        },
        returns:'‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'
      },
      IF:{
        summary:'‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á ‚Üí A, ‡πÄ‡∏ó‡πá‡∏à ‚Üí B',
        args:['logical_test','value_if_true','[value_if_false]'],
        mapArgs:(a)=>{
          const [t, tr, fa] = a;
          return [
            ['‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (logical_test)', t],
            ['‡∏Ñ‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á', tr],
            ['‡∏Ñ‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡πá‡∏à', fa ?? '"" (‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)']
          ];
        },
        returns:'‡∏Ñ‡πà‡∏≤‡πÉ‡∏î‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏£‡∏£‡∏Å‡∏∞'
      },
      AND:{ summary:'‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á', args:['logical1','[logical2]','...'], returns:'TRUE/FALSE' },
      OR:{ summary:'‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á', args:['logical1','[logical2]','...'], returns:'TRUE/FALSE' },
      LEFT:{ summary:'‡∏ï‡∏±‡∏î‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏ã‡πâ‡∏≤‡∏¢', args:['text','[num_chars]'], returns:'‡∏™‡∏ï‡∏£‡∏¥‡∏á' },
      RIGHT:{ summary:'‡∏ï‡∏±‡∏î‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡∏ß‡∏≤', args:['text','[num_chars]'], returns:'‡∏™‡∏ï‡∏£‡∏¥‡∏á' },
      LEN:{ summary:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', args:['text'], returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°' },
      AVERAGE:{ summary:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏ì‡∏¥‡∏ï', args:['number1','[number2]','...'], returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' },
      MIN:{ summary:'‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î', args:['number1','[number2]','...'], returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' },
      MAX:{ summary:'‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', args:['number1','[number2]','...'], returns:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' },
      TODAY:{ summary:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', args:[], returns:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (serial)' },
      EOMONTH:{ summary:'‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞', args:['start_date','months'], returns:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
      LET:{ summary:'‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£', args:['name1','value1','[name2]','[value2]','...','calculation'], returns:'‡∏ú‡∏•‡∏Ç‡∏≠‡∏á calculation' },
      LAMBDA:{ summary:'‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á', args:['[parameter1]','[parameter2]','...','calculation'], returns:'‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏≤‡∏°' }
    };

    // 2) Parser ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏Ç‡∏≠‡∏á‡∏™‡∏π‡∏ï‡∏£
    function parseFormula(formula){
      let s = String(formula || '').trim();
      if (!s) return null;
      if (s.startsWith('=')) s = s.slice(1);
      let i = 0;

      function skip(){ while (i<s.length && /\s/.test(s[i])) i++; }
      function peek() { return s[i]; }
      function readIdent(){
        let start=i;
        while(i<s.length && /[A-Za-z_\.]/.test(s[i])) i++;
        return s.slice(start,i);
      }
      function readNumber(){
        let start=i;
        while(i<s.length && /[0-9\.\-+E]/i.test(s[i])) i++;
        return {type:'Literal', kind:'number', value: s.slice(start,i)};
      }
      function readString(){
        const q = s[i++]; let out=''; while(i<s.length){
          const c = s[i++]; if (c===q) break; if (c==='\\' && s[i]===q){ out+=q; i++; } else out+=c;
        }
        return {type:'Literal', kind:'string', value: out};
      }
      function readRefOrBoolOrIdent(){
        const start=i;
        while(i<s.length && /[^,\)\(]/.test(s[i])) i++;
        const raw = s.slice(start,i).trim();
        if (/^(TRUE|FALSE)$/.test(raw.toUpperCase())) return {type:'Literal', kind:'boolean', value: raw.toUpperCase()};
        return {type:'Ref', value: raw};
      }
      function readArg(){
        skip();
        const c = peek();
        if (c === '"' || c === "'") return readString();
        if (/[0-9\+\-\.]/.test(c)) return readNumber();
        if (/[A-Za-z_]/.test(c)){
          const name = readIdent();
          skip();
          if (peek()==='('){
            i++; // (
            const args = [];
            while (true){
              skip();
              if (peek()===')'){ i++; break; }
              args.push(readArg());
              skip();
              if (peek()===','){ i++; continue; }
              if (peek()===')'){ i++; break; }
              // unexpected ‚Äî consume safely
              if (i>=s.length) break;
            }
            return {type:'Call', name: name.toUpperCase(), args};
          } else {
            // could be Ref/Name
            // consume until comma/paren
            while(i<s.length && /[^,\)]/.test(s[i])) i++;
            const token = (name + s.slice(i - (s[i-1] ? 0:0), i)).trim(); // name only
            return {type:'Ref', value: token || name};
          }
        }
        // fallback: read until comma/close
        return readRefOrBoolOrIdent();
      }

      // top-level can be a Call or expression
      const node = readArg();
      return node;
    }

    // pretty print node back to excel-ish string
    function pp(node){
      if (!node) return '';
      if (node.type==='Literal'){
        if (node.kind==='string') return `"${node.value.replace(/"/g,'""')}"`;
        return String(node.value);
      }
      if (node.type==='Ref') return node.value;
      if (node.type==='Call') return `${node.name}(${node.args.map(pp).join(', ')})`;
      return '';
    }

    // classify span chip
    function chipFor(node){
      let label=''; let cls='chip';
      if (!node) return '';
      if (node.type==='Literal'){
        if (node.kind==='string') label='‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
        else if (node.kind==='number') label='‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç';
        else if (node.kind==='boolean') label='‡∏ï‡∏£‡∏£‡∏Å‡∏∞';
      } else if (node.type==='Ref'){
        label = /:|!|\$/.test(node.value) || /[A-Za-z]+\d/.test(node.value) ? '‡∏ä‡πà‡∏ß‡∏á/‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : '‡∏ä‡∏∑‡πà‡∏≠/‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå';
      } else if (node.type==='Call'){
        label = `‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ${node.name}`;
      }
      return `<span class="chip">${label}</span>`;
    }

    function toText(node){
      // plain text for copy
      const div = document.createElement('div'); div.innerHTML = explainHTML(node, {mode: $('#explainMode').value, pitfalls: $('#showPitfalls').checked, alt: $('#showAlternatives').checked});
      return div.innerText;
    }

    // 3) Explain renderer
    function explainHTML(node, opts){
      opts = Object.assign({mode:'detailed', pitfalls:true, alt:true}, opts||{});
      if (!node) return `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£</div>`;

      if (node.type==='Call'){
        const meta = FCAT[node.name] || {summary:'', args:[]};
        const args = node.args;
        const header = `
          <div class="head">
            <h3 style="margin:.2rem 0">${node.name}</h3>
            <span class="chip">${meta.summary || '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å'}</span>
            <span class="chip">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤: ${meta.returns || '‚Äî'}</span>
          </div>
        `;

        // arguments mapping
        let mapped = [];
        if (typeof meta.mapArgs === 'function'){
          mapped = meta.mapArgs(args.map(a=> pp(a)));
        } else {
          // fallback map in order
          mapped = (meta.args||[]).map((label, i)=> [label, pp(args[i])]);
          if (args.length > (meta.args||[]).length){
            for (let j=(meta.args||[]).length;j<args.length;j++) mapped.push([`‡∏≠‡∏≤‡∏£‡πå‡∏Å‡∏¥‡∏ß‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà ${j+1}`, pp(args[j])]);
          }
        }

        const list = mapped.map(([label, val], idx)=>{
          const rawNode = node.args[idx]; // may be undefined if extra mapping
          const nested = rawNode && rawNode.type==='Call';
          const short = `<li><b>${label}</b>: <span class="code">${val ?? '(‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)'}</span> ${chipFor(rawNode || {type:'Ref', value: val||''})}</li>`;
          if (!nested || opts.mode==='basic') return short;
          // nested ‚Üí put details
          return `
            <li>
              <div><b>${label}</b>: <span class="code">${val ?? '(‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)'}</span> ${chipFor(rawNode)}</div>
              <details style="margin-top:6px">
                <summary>‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏≠‡∏á <b>${rawNode.name}</b></summary>
                ${explainHTML(rawNode, opts)}
              </details>
            </li>
          `;
        }).join('');

        // Step-by-step narration (selective by function)
        function narrative(){
          const n = node.name;
          const P = (i)=> pp(args[i]||{type:'Ref', value:''});
          if (n==='SUMIFS'){
            return `
              <div class="box">
                <div class="kv"><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b> 
                  <span>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <span class="code">${P(0)}</span> ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°</span>
                </div>
                <div style="margin-top:6px">
                  ${args.slice(1).map((_,i)=> i%2===0
                    ? `<div>2.${Math.floor(i/2)+1}) ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: <span class="code">${P(1+i)}</span> ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á <span class="code">${P(1+i+1)}</span></div>`
                    : ''
                  ).join('')}
                  <div style="margin-top:6px">3) ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
              </div>
            `;
          }
          if (n==='XLOOKUP'){
            const mm = args[4] ? pp(args[4]) : '0 (Exact)';
            const sm = args[5] ? pp(args[5]) : '1 (First-to-last)';
            return `
              <div class="box">
                <div><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <span class="code">${P(0)}</span> ‡πÉ‡∏ô <span class="code">${P(1)}</span> (match_mode=${mm}, search_mode=${sm}) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å <span class="code">${P(2)}</span>.</div>
              </div>
            `;
          }
          if (n==='INDEX'){
            const r = P(1)||'1', c = P(2)||'1';
            return `<div class="box"><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô <span class="code">${P(0)}</span> ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏ñ‡∏ß <span class="code">${r}</span>, ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <span class="code">${c}</span></div>`;
          }
          if (n==='MATCH'){
            const mt = args[2] ? pp(args[2]) : '1 (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)';
            return `<div class="box"><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b> ‡∏´‡∏≤ <span class="code">${P(0)}</span> ‡πÉ‡∏ô <span class="code">${P(1)}</span> ‡∏î‡πâ‡∏ß‡∏¢ match_type=${mt} ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô <i>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</i> (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö 1)</div>`;
          }
          if (n==='FILTER'){
            return `<div class="box"><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b> ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á <span class="code">${P(0)}</span> ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà <span class="code">${P(1)}</span> ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Dynamic Array</div>`;
          }
          if (n==='IF'){
            return `<div class="box"><b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b> ‡∏ï‡∏£‡∏ß‡∏à <span class="code">${P(0)}</span> ‡∏´‡∏≤‡∏Å‡∏à‡∏£‡∏¥‡∏á ‚Üí <span class="code">${P(1)}</span> ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô ‚Üí <span class="code">${P(2)||'""'}</span></div>`;
          }
          return '';
        }

        // Notes & Pitfalls
        function notesBlock(){
          const blocks = [];
          if (FCAT[node.name]?.notes?.length && opts.alt){
            blocks.push(`<div><b>‡∏ó‡∏£‡∏¥‡∏Å/‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</b><ul>${FCAT[node.name].notes.map(n=>`<li>${n}</li>`).join('')}</ul></div>`);
          }
          if (FCAT[node.name]?.pitfalls?.length && opts.pitfalls){
            blocks.push(`<div><b class="danger">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b><ul>${FCAT[node.name].pitfalls.map(n=>`<li>${n}</li>`).join('')}</ul></div>`);
          }
          return blocks.join('');
        }

        return `
          <div class="card" style="padding:12px">
            ${header}
            <div style="margin-top:6px"><b>‡∏™‡∏π‡∏ï‡∏£:</b> <span class="code">=${pp(node)}</span></div>
            <div style="margin-top:8px">
              <b>‡∏≠‡∏≤‡∏£‡πå‡∏Å‡∏¥‡∏ß‡πÄ‡∏°‡∏ô‡∏ï‡πå:</b>
              <ul class="arglist">
                ${list}
              </ul>
            </div>
            ${opts.mode==='detailed' ? narrative() : ''}
            <div style="margin-top:8px">${notesBlock()}</div>
          </div>
        `;
      }

      if (node.type==='Literal' || node.type==='Ref'){
        return `
          <div class="card" style="padding:12px">
            <div class="head">
              <h3 style="margin:.2rem 0">‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå</h3>
              ${chipFor(node)}
            </div>
            <div><b>‡∏Ñ‡πà‡∏≤/‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</b> <span class="code">${pp(node)}</span></div>
          </div>
        `;
      }

      return `<div class="muted">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</div>`;
    }

    // Wire Explain UI
    const exInput = $('#explainInput');
    const exOut = $('#explainOut');
    function runExplain(){
      const raw = exInput.value;
      if (!raw.trim()){ exOut.innerHTML = `<div class="muted">‡∏ß‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏π‡∏ï‡∏£"</div>`; return; }
      const node = parseFormula(raw);
      const html = explainHTML(node, { mode: $('#explainMode').value, pitfalls: $('#showPitfalls').checked, alt: $('#showAlternatives').checked });
      exOut.innerHTML = html;
      save('last_explain', raw);
    }
    $('#doExplain').onclick = runExplain;
    $('#copyExplain').onclick = ()=> copy( toText(parseFormula(exInput.value||'')) );
    on(exInput,'keydown',(e)=>{ if (e.ctrlKey && e.key==='Enter') runExplain() });

    // Restore last explained if any
    const last = load('last_explain','');
    if (last){ exInput.value = last; }

    // Confetti
    const conf = $('#confetti'); const ctx = conf.getContext('2d'); const parts = [];
    function onResize(){ conf.width = innerWidth; conf.height = innerHeight } addEventListener('resize', onResize); onResize();
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#fff' }
    function confettiBurst(){
      for (let i=0;i<80;i++){
        parts.push({ x: Math.random()*conf.width, y: -10, vx: (Math.random()-.5)*4, vy: Math.random()*3+2, w: Math.random()*6+4, h: Math.random()*10+6, c: Math.random()<.5? '--accent':'--accent-2', a: 1, r: Math.random()*Math.PI });
      }
    }
    function tick(){
      ctx.clearRect(0,0,conf.width, conf.height);
      for (const p of parts){
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.r+=0.1; p.a-=0.006;
        ctx.save(); ctx.globalAlpha = Math.max(p.a,0); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle = cssVar(p.c); ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
      }
      for (let i=parts.length-1;i>=0;i--) if (parts[i].a<=0 || parts[i].y>conf.height+20) parts.splice(i,1);
      requestAnimationFrame(tick);
    }
    tick();

    // Onboarding
    if (!load('seen_tip', false)){ toast('Tip: ‡∏Å‡∏î Ctrl + K ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß ‡πÜ'); save('seen_tip', true); }
    on(document,'keydown',(e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ setTimeout(()=> $('#cmdInput').focus(), 50) } });
  </script>
</body>
</html>
